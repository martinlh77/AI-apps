<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Combiner Pro v.1.4 - MP4 & WebM</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
      max-width: 1000px; 
      margin: 40px auto; 
      padding: 20px;
      background: #f5f5f5;
    }
    .container { 
      background: white; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; color: #333; }
    
    .input-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border: 2px dashed #ddd;
    }
    
    .input-type-selector { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 15px; 
    }
    .input-type-selector button { 
      flex: 1; 
      padding: 12px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .input-type-selector button.active { 
      background: #007cba; 
      color: white; 
      border-color: #007cba;
    }
    
    .input-panel { display: none; }
    .input-panel.active { display: block; }
    
    input[type="file"], input[type="url"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
      margin: 5px 0;
    }
    
    #videoQueue { margin: 25px 0; min-height: 100px; }
    
    .queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .video-count {
      font-size: 0.9em;
      color: #666;
      font-weight: 500;
    }
    
    .video-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .video-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: move;
      transition: all 0.2s;
      position: relative;
    }
    
    .video-item:hover { border-color: #007cba; }
    .video-item.dragging {
      opacity: 0.5;
      border-color: #007cba;
      background: #e8f4f8;
    }
    
    .drag-handle {
      color: #999;
      font-size: 20px;
      cursor: grab;
      user-select: none;
    }
    
    .video-thumb {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      background: #000;
    }
    
    .video-info { flex: 1; min-width: 0; }
    
    .video-name {
      font-weight: 500;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    
    .video-meta {
      font-size: 0.85em;
      color: #666;
    }
    
    .video-res {
      display: inline-block;
      background: #e8f4f8;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 8px;
      font-size: 0.85em;
    }
    
    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .remove-btn:hover { background: #c82333; }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      border: 2px dashed #ddd;
      border-radius: 8px;
      background: #fafafa;
    }
    
    .settings-panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .setting-row {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .setting-label {
      font-weight: 500;
      color: #333;
      min-width: 140px;
    }
    
    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      min-width: 200px;
    }
    
    .combine-btn {
      width: 100%;
      padding: 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .combine-btn:hover:not(:disabled) { background: #218838; }
    .combine-btn:disabled { 
      background: #ccc; 
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .progress-container {
      display: none;
      margin: 20px 0;
    }
    .progress-container.active { display: block; }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007cba, #00a8e8);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    
    .status {
      margin-top: 10px;
      padding: 12px;
      border-radius: 6px;
      display: none;
      font-size: 0.95em;
    }
    .status.active { display: block; }
    .status.info { background: #e8f4f8; border-left: 4px solid #007cba; }
    .status.success { background: #d4edda; border-left: 4px solid #28a745; }
    .status.error { background: #f8d7da; border-left: 4px solid #dc3545; }
    
    #previewSection {
      display: none;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #e0e0e0;
    }
    #previewSection.active { display: block; }
    
    #resultVideo {
      width: 100%;
      max-height: 500px;
      border-radius: 8px;
      background: #000;
      margin-bottom: 15px;
    }
    
    .download-btn {
      display: inline-block;
      width: 100%;
      padding: 14px;
      background: #007cba;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      text-align: center;
      font-weight: 500;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    .download-btn:hover { background: #005a87; }
    
    .warning {
      background: #fff3cd;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 0.9em;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    
    .loading-ffmpeg {
      display: none;
      text-align: center;
      padding: 20px;
      background: #e8f4f8;
      border-radius: 8px;
      margin: 20px 0;
    }
    .loading-ffmpeg.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé¨ Video Combiner Pro</h2>
    <p style="color: #666; margin-top: -10px;">Merge multiple videos into one MP4 file. All processing happens locally using FFmpeg.</p>
    
    <div class="warning">
      ‚ö†Ô∏è <strong>First time setup:</strong> This app downloads FFmpeg files from Catbox.moe (~25MB). Videos are processed entirely on your device.
    </div>
    
    <!-- FFmpeg Loading Indicator -->
    <div class="loading-ffmpeg" id="ffmpegLoading">
      <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
      <div><strong>Loading FFmpeg...</strong></div>
      <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Downloading required files from external host</div>
    </div>
    
    <!-- Input Section -->
    <div class="input-section" id="inputSection" style="opacity: 0.5; pointer-events: none;">
      <div class="input-type-selector">
        <button type="button" class="active" onclick="switchInputType('file')">üìÅ Upload Files</button>
        <button type="button" onclick="switchInputType('url')">üîó Add from URL</button>
      </div>
      
      <div id="filePanel" class="input-panel active">
        <input type="file" id="fileInput" accept="video/*" multiple onchange="handleFileSelect(event)">
        <small style="color: #666;">Hold Ctrl/Cmd to select multiple files (MP4, WebM, MOV supported)</small>
      </div>
      
      <div id="urlPanel" class="input-panel">
        <input type="url" id="urlInput" placeholder="https://example.com/video.mp4">
        <button type="button" onclick="addVideoFromUrl()" style="margin-top: 8px; width: 100%; padding: 10px; background: #007cba; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Add Video from URL
        </button>
        <small style="color: #666; display: block; margin-top: 5px;">Note: URL must support CORS or use CORS proxy</small>
      </div>
    </div>
    
    <!-- Video Queue -->
    <div id="videoQueue" style="opacity: 0.5; pointer-events: none;">
      <div class="queue-header">
        <span class="video-count" id="videoCount">Loading FFmpeg...</span>
        <button onclick="clearAll()" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em;">Clear All</button>
      </div>
      <div id="videoList" class="video-list">
        <div class="empty-state">
          <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
          <div>Waiting for FFmpeg to load...</div>
        </div>
      </div>
    </div>
    
    <!-- Settings -->
    <div class="settings-panel" id="settingsPanel" style="opacity: 0.5; pointer-events: none;">
      <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 1.1em;">‚öôÔ∏è Output Settings</h3>
      
      <div class="setting-row">
        <span class="setting-label">Resolution:</span>
        <select id="resolutionSelect">
          <option value="original">Original (match first video)</option>
          <option value="1080" selected>1080p (Full HD) - 1920√ó1080</option>
          <option value="720">720p (HD) - 1280√ó720</option>
          <option value="480">480p (SD) - 854√ó480</option>
        </select>
      </div>
      
      <div class="setting-row">
        <span class="setting-label">Output Format:</span>
        <select id="formatSelect">
          <option value="mp4" selected>MP4 (H.264) - Universal compatibility</option>
          <option value="webm">WebM (VP9) - Better compression</option>
        </select>
      </div>
      
      <div class="setting-row">
        <span class="setting-label">Audio:</span>
        <select id="audioSelect">
          <option value="keep" selected>Keep audio from all videos</option>
          <option value="mute">Remove audio (silent video)</option>
        </select>
      </div>
    </div>
    
    <!-- Combine Button -->
    <button class="combine-btn" id="combineBtn" onclick="combineVideos()" disabled>
      <span>üé¨</span>
      <span>Combine Videos</span>
    </button>
    
    <!-- Progress -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div style="text-align: center; color: #666; margin-top: 8px; font-size: 0.9em;" id="progressText">Initializing...</div>
    </div>
    
    <div class="status" id="status"></div>
    
    <!-- Preview Section -->
    <div id="previewSection">
      <h3 style="margin-bottom: 15px;">‚úÖ Combined Video</h3>
      <video id="resultVideo" controls></video>
      <a id="downloadLink" class="download-btn" download="combined-video.mp4">
        ‚¨áÔ∏è Download Combined Video
      </a>
    </div>
  </div>

  <script type="module">
    import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js';
    import { fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js';
    
    // ==========================================
    // CONFIGURATION: Replace with your Catbox.moe URLs
    // ==========================================
    const FFMPEG_CONFIG = {
      // TODO: Replace these placeholder URLs with your actual Catbox.moe links
      // Instructions: 
      // 1. Go to https://catbox.moe
      // 2. Upload ffmpeg-core.js (from https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js)
      // 3. Copy the direct link and paste below
      // 4. Repeat for ffmpeg-core.wasm
      jsURL: 'https://files.catbox.moe/i7lm8x.js',      // <-- REPLACE THIS
      wasmURL: 'https://files.catbox.moe/hqfek6.wasm',  // <-- REPLACE THIS
      
      // Alternative: If you prefer different hosts, uncomment and modify:
      // jsURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
      // wasmURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm',
    };
    
    let ffmpeg = null;
    let videoQueue = [];
    let dragSrcEl = null;
    let isProcessing = false;
    
    const CORS_PROXIES = [
      'https://api.allorigins.win/raw?url=',
      'https://corsproxy.io/?'
    ];
    
    // Helper: Convert external URL to Blob URL (bypasses CORS for Workers)
    async function toBlobURL(url, mimeType) {
      try {
        console.log(`Fetching: ${url}`);
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const blobURL = URL.createObjectURL(blob);
        console.log(`Created Blob URL for ${url} (${(blob.size / 1024 / 1024).toFixed(2)}MB)`);
        return blobURL;
      } catch (err) {
        throw new Error(`Failed to load ${url}: ${err.message}`);
      }
    }
    
    // Initialize FFmpeg with EXTERNAL files via Blob URLs
    async function initFFmpeg() {
      try {
        document.getElementById('ffmpegLoading').classList.add('active');
        showStatus('Downloading FFmpeg from Catbox.moe...', 'info');
        
        // Make fetchFile available globally for other functions
        window.fetchFile = fetchFile;
        
        ffmpeg = new FFmpeg();
        
        ffmpeg.on('log', ({ message }) => {
          console.log('FFmpeg:', message);
        });
        
        ffmpeg.on('progress', ({ progress, time }) => {
          const percent = Math.round(progress * 100);
          updateProgress(percent, `Processing... ${percent}%`);
        });
        
        // CRITICAL: Fetch external files and convert to Blob URLs
        // This makes them "same-origin" for the Worker constructor
        showStatus('Fetching FFmpeg core files (this may take a moment)...', 'info');
        
        // Fetch both files in parallel for speed
        const [coreURL, wasmURL] = await Promise.all([
          toBlobURL(FFMPEG_CONFIG.jsURL, 'text/javascript'),
          toBlobURL(FFMPEG_CONFIG.wasmURL, 'application/wasm')
        ]);
        
        showStatus('Initializing FFmpeg engine...', 'info');
        
        // Load FFmpeg using the Blob URLs (now same-origin)
        await ffmpeg.load({ coreURL, wasmURL });
        
        // Clean up Blob URLs after load (optional - keeps memory tidy)
        setTimeout(() => {
          URL.revokeObjectURL(coreURL);
          URL.revokeObjectURL(wasmURL);
        }, 60000); // Revoke after 1 minute when surely done
        
        // Enable UI
        document.getElementById('ffmpegLoading').classList.remove('active');
        document.getElementById('inputSection').style.opacity = '1';
        document.getElementById('inputSection').style.pointerEvents = 'auto';
        document.getElementById('videoQueue').style.opacity = '1';
        document.getElementById('videoQueue').style.pointerEvents = 'auto';
        document.getElementById('settingsPanel').style.opacity = '1';
        document.getElementById('settingsPanel').style.pointerEvents = 'auto';
        
        showStatus('‚úÖ FFmpeg loaded successfully! Ready to combine videos.', 'success');
        renderQueue();
        
      } catch (err) {
        console.error(err);
        showStatus('‚ùå Failed to load FFmpeg: ' + err.message, 'error');
        document.getElementById('ffmpegLoading').innerHTML = `
          <div style="color: #dc3545;">
            <div style="font-size: 2em; margin-bottom: 10px;">‚ùå</div>
            <div><strong>Failed to load FFmpeg</strong></div>
            <div style="font-size: 0.9em; margin-top: 10px; color: #666; text-align: left; max-width: 400px; margin: 10px auto;">
              <strong>Error:</strong> ${err.message}<br><br>
              <strong>Fix this:</strong><br>
              1. Go to https://catbox.moe<br>
              2. Upload ffmpeg-core.js and ffmpeg-core.wasm<br>
              3. Edit the FFMPEG_CONFIG section in this HTML file<br>
              4. Replace the placeholder URLs with your Catbox links<br><br>
              Or switch to the CDN option in the code.
            </div>
          </div>
        `;
      }
    }
    
    // Start loading immediately
    initFFmpeg();
    
    function switchInputType(type) {
      document.querySelectorAll('.input-type-selector button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type));
      });
      document.getElementById('filePanel').classList.toggle('active', type === 'file');
      document.getElementById('urlPanel').classList.toggle('active', type === 'url');
    }
    
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      files.forEach(file => addVideoToQueue(file, file.name, URL.createObjectURL(file)));
      event.target.value = '';
    }
    
    async function addVideoFromUrl() {
      const urlInput = document.getElementById('urlInput');
      const url = urlInput.value.trim();
      if (!url) {
        showStatus('Please enter a valid URL', 'error');
        return;
      }
      
      showStatus('Loading video from URL...', 'info');
      
      try {
        let blob;
        let usedProxy = false;
        
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Direct fetch failed');
          blob = await response.blob();
        } catch (e) {
          for (const proxy of CORS_PROXIES) {
            try {
              const response = await fetch(proxy + encodeURIComponent(url));
              if (response.ok) {
                blob = await response.blob();
                usedProxy = true;
                break;
              }
            } catch (err) { continue; }
          }
          if (!blob) throw new Error('Unable to fetch video. Server may block cross-origin requests.');
        }
        
        if (!blob.type.startsWith('video/') && !blob.type.startsWith('application/octet')) {
          throw new Error('URL does not point to a valid video file');
        }
        
        const objectUrl = URL.createObjectURL(blob);
        const name = url.split('/').pop().split('?')[0] || 'video-from-url.mp4';
        await addVideoToQueue(blob, name, objectUrl, usedProxy ? '(via CORS proxy)' : '');
        urlInput.value = '';
        showStatus('Video added successfully!', 'success');
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
      }
    }
    
    async function addVideoToQueue(fileOrBlob, name, objectUrl, extraInfo = '') {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.src = objectUrl;
      
      await new Promise((resolve, reject) => {
        video.onloadedmetadata = () => {
          if (video.duration === Infinity) {
            video.currentTime = 1e101;
            video.ontimeupdate = () => {
              video.ontimeupdate = null;
              resolve();
            };
          } else {
            resolve();
          }
        };
        video.onerror = () => reject(new Error('Failed to load video metadata'));
        setTimeout(() => reject(new Error('Timeout loading metadata')), 10000);
      });
      
      const duration = video.duration === Infinity ? 0 : video.duration;
      const width = video.videoWidth;
      const height = video.videoHeight;
      
      video.currentTime = Math.min(1, duration / 2);
      await new Promise(r => video.onseeked = r);
      
      const canvas = document.createElement('canvas');
      canvas.width = 160;
      canvas.height = 120;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, 160, 120);
      const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
      
      const videoItem = {
        id: Date.now() + Math.random(),
        file: fileOrBlob,
        name: name,
        url: objectUrl,
        duration: duration,
        width: width,
        height: height,
        thumbnail: thumbnail,
        extraInfo: extraInfo
      };
      
      videoQueue.push(videoItem);
      renderQueue();
      updateCombineButton();
    }
    
    function renderQueue() {
      const container = document.getElementById('videoList');
      const countEl = document.getElementById('videoCount');
      
      if (videoQueue.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
            <div>Add videos above to start combining</div>
          </div>
        `;
        countEl.textContent = 'No videos added';
        return;
      }
      
      const totalDur = videoQueue.reduce((acc, v) => acc + v.duration, 0);
      countEl.textContent = `${videoQueue.length} video${videoQueue.length !== 1 ? 's' : ''} ‚Ä¢ Total: ${formatDuration(totalDur)}`;
      
      container.innerHTML = '';
      videoQueue.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'video-item';
        item.draggable = true;
        item.dataset.index = index;
        
        item.innerHTML = `
          <div class="drag-handle">‚ãÆ‚ãÆ</div>
          <img class="video-thumb" src="${video.thumbnail}" alt="thumb">
          <div class="video-info">
            <div class="video-name">${escapeHtml(video.name)} ${video.extraInfo ? `<span style="color: #999; font-size: 0.9em;">${video.extraInfo}</span>` : ''}</div>
            <div class="video-meta">
              <span class="video-res">${video.width}√ó${video.height}</span>
              <span>${formatDuration(video.duration)}</span>
            </div>
          </div>
          <button class="remove-btn" onclick="removeVideo(${index})" title="Remove">√ó</button>
        `;
        
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
        
        container.appendChild(item);
      });
    }
    
    function handleDragStart(e) {
      this.style.opacity = '0.4';
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('dragging');
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDragEnter(e) { this.classList.add('dragging'); }
    function handleDragLeave(e) { this.classList.remove('dragging'); }
    
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (dragSrcEl !== this) {
        const fromIndex = parseInt(dragSrcEl.dataset.index);
        const toIndex = parseInt(this.dataset.index);
        const item = videoQueue.splice(fromIndex, 1)[0];
        videoQueue.splice(toIndex, 0, item);
        renderQueue();
      }
      return false;
    }
    
    function handleDragEnd(e) {
      this.style.opacity = '1';
      document.querySelectorAll('.video-item').forEach(item => {
        item.classList.remove('dragging');
      });
    }
    
    // Make functions available to HTML onclick handlers
    window.removeVideo = function(index) {
      const url = videoQueue[index].url;
      URL.revokeObjectURL(url);
      videoQueue.splice(index, 1);
      renderQueue();
      updateCombineButton();
      
      if (videoQueue.length === 0) {
        document.getElementById('previewSection').classList.remove('active');
      }
    };
    
    window.clearAll = function() {
      videoQueue.forEach(v => URL.revokeObjectURL(v.url));
      videoQueue = [];
      renderQueue();
      updateCombineButton();
      document.getElementById('previewSection').classList.remove('active');
    };
    
    window.switchInputType = switchInputType;
    window.handleFileSelect = handleFileSelect;
    window.addVideoFromUrl = addVideoFromUrl;
    
    function updateCombineButton() {
      document.getElementById('combineBtn').disabled = videoQueue.length < 2 || isProcessing || !ffmpeg;
    }
    
    async function combineVideos() {
      if (videoQueue.length < 2 || !ffmpeg) return;
      if (isProcessing) return;
      
      isProcessing = true;
      updateCombineButton();
      document.getElementById('previewSection').classList.remove('active');
      document.getElementById('progressContainer').classList.add('active');
      
      const resolution = document.getElementById('resolutionSelect').value;
      const format = document.getElementById('formatSelect').value;
      const audioMode = document.getElementById('audioSelect').value;
      
      try {
        showStatus('Preparing videos for processing...', 'info');
        updateProgress(5, 'Writing files to memory...');
        
        // Write all input files to FFmpeg virtual filesystem
        const inputFiles = [];
        for (let i = 0; i < videoQueue.length; i++) {
          const video = videoQueue[i];
          const inputName = `input${i}.mp4`;
          await ffmpeg.writeFile(inputName, await fetchFile(video.file));
          inputFiles.push(inputName);
          updateProgress(5 + ((i + 1) / videoQueue.length) * 15, `Loading video ${i + 1}...`);
        }
        
        // Create concat list file
        showStatus('Creating concatenation list...', 'info');
        const concatList = inputFiles.map(f => `file '${f}'`).join('\n');
        await ffmpeg.writeFile('concat_list.txt', concatList);
        
        // Determine output settings
        let scaleFilter = '';
        let outputName = `output.${format}`;
        
        if (resolution !== 'original') {
          const targetHeight = parseInt(resolution);
          scaleFilter = `scale=-2:${targetHeight}:force_original_aspect_ratio=decrease,pad=${Math.round(targetHeight * 16/9)}:${targetHeight}:(ow-iw)/2:(oh-ih)/2:black,setsar=1`;
        } else {
          const first = videoQueue[0];
          scaleFilter = `scale=${first.width}:${first.height}:force_original_aspect_ratio=decrease,pad=${first.width}:${first.height}:(ow-iw)/2:(oh-ih)/2:black,setsar=1`;
        }
        
        // Build FFmpeg command
        const args = [
          '-f', 'concat',
          '-safe', '0',
          '-i', 'concat_list.txt',
          '-vf', scaleFilter,
          '-c:v', format === 'mp4' ? 'libx264' : 'libvpx-vp9',
          '-preset', 'fast',
          '-crf', '23',
          '-movflags', '+faststart',
          '-pix_fmt', 'yuv420p',
        ];
        
        if (audioMode === 'mute') {
          args.push('-an');
        } else {
          args.push('-c:a', format === 'mp4' ? 'aac' : 'libopus');
          args.push('-b:a', '128k');
        }
        
        args.push('-y', outputName);
        
        showStatus('Combining videos (this may take a while)...', 'info');
        updateProgress(25, 'Concatenating and encoding...');
        
        await ffmpeg.exec(args);
        
        updateProgress(90, 'Finalizing...');
        
        // Read the output file
        const data = await ffmpeg.readFile(outputName);
        const blob = new Blob([data.buffer], { type: format === 'mp4' ? 'video/mp4' : 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        const video = document.getElementById('resultVideo');
        video.src = url;
        
        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = url;
        downloadLink.download = `combined-video.${format}`;
        downloadLink.textContent = `‚¨áÔ∏è Download Combined Video (${format.toUpperCase()})`;
        
        document.getElementById('previewSection').classList.add('active');
        document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        
        // Cleanup
        for (const file of inputFiles) {
          await ffmpeg.deleteFile(file);
        }
        await ffmpeg.deleteFile('concat_list.txt');
        await ffmpeg.deleteFile(outputName);
        
        showStatus(`‚úÖ Success! Combined ${videoQueue.length} videos into ${format.toUpperCase()} format.`, 'success');
        updateProgress(100, 'Complete!');
        
        setTimeout(() => {
          document.getElementById('progressContainer').classList.remove('active');
        }, 2000);
        
      } catch (err) {
        console.error(err);
        showStatus('‚ùå Error: ' + err.message, 'error');
        document.getElementById('progressContainer').classList.remove('active');
      }
      
      isProcessing = false;
      updateCombineButton();
    }
    
    window.combineVideos = combineVideos;
    
    function updateProgress(percent, text) {
      const fill = document.getElementById('progressFill');
      const textEl = document.getElementById('progressText');
      fill.style.width = Math.min(100, Math.max(0, percent)) + '%';
      fill.textContent = Math.round(percent) + '%';
      if (text) textEl.textContent = text;
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type + ' active';
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          if (status.textContent === message) status.classList.remove('active');
        }, 5000);
      }
    }
    
    function formatDuration(seconds) {
      if (!seconds || seconds === Infinity) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    window.renderQueue = renderQueue;
    window.updateCombineButton = updateCombineButton;
    window.showStatus = showStatus;
    window.updateProgress = updateProgress;
  </script>
</body>
</html>
