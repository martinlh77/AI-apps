<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollinations.ai to Catbox.moe Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.8;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover:not(.active) {
            background: #edf2f7;
        }

        .content {
            padding: 30px;
            display: none;
        }

        .content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="password"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: monospace;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="url"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
            background: #cbd5e0;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: #48bb78;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(28px);
        }

        .toggle-label {
            font-weight: 600;
            color: #2d3748;
        }

        .toggle-description {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 40px;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .file-input-label:hover, .file-input-label.drag-active {
            border-color: #667eea;
            background: #edf2f7;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-warning {
            background: #ed8936;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .status-text {
            text-align: center;
            color: #4a5568;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .url-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            font-size: 12px;
            color: #667eea;
            cursor: pointer;
        }

        .url-cell:hover {
            text-decoration: underline;
        }

        .original-url {
            color: #718096;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .preview-img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            cursor: zoom-in;
            border: 2px solid #e2e8f0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .output-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .output-section.active {
            display: block;
        }

        .json-output {
            background: #2d3748;
            color: #68d391;
            padding: 20px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #2d3748;
        }

        .relative {
            position: relative;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }

        .warning-box {
            background: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }

        .warning-box strong {
            color: #c05621;
        }

        .error-box {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }

        .error-box strong {
            color: #c53030;
        }

        .info-box {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }

        .info-box strong {
            color: #2c7a7b;
        }

        .hidden {
            display: none !important;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
        }

        .download-link:hover {
            color: #5568d3;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
            
            .url-cell {
                max-width: 150px;
            }
            
            .toggle-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® Pollinations.ai to Catbox.moe Converter</h1>
            <div class="subtitle">Convert Pollinations.ai URLs to permanent Catbox.moe hosting</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('bulk')">üìÅ Bulk Processing</button>
            <button class="tab" onclick="switchTab('single')">üîó Single Link</button>
        </div>

        <!-- BULK PROCESSING TAB -->
        <div id="bulk" class="content active">
            <div class="warning-box">
                <strong>‚ö†Ô∏è Processing Rate:</strong> Uploads are staggered with 1-5 second random delays to respect rate limits. 
                For 240 files, expect 4-20 minutes processing time.
            </div>

            <div class="error-box" id="corsWarning" style="display: none;">
                <strong>üö´ CORS Error Detected:</strong> Direct uploads from GitHub Pages to Catbox are blocked by browser security. 
                Either: (1) Enter a CORS Proxy URL below, (2) Switch to "Local Download" mode to save as ZIP, or (3) Run this app locally (localhost).
            </div>

            <div class="section">
                <label for="apiKey">üîë Pollinations.ai API Key (Optional)</label>
                <input type="password" id="apiKey" placeholder="Enter your API key here..." autocomplete="off">
                <small style="color: #718096; display: block; margin-top: 5px;">Stored locally in your browser only. Required only if URLs need authentication.</small>
            </div>

            <div class="toggle-container">
                <div class="toggle-switch active" id="keyToggle" onclick="toggleKeyAppend()">
                    <div class="toggle-slider"></div>
                </div>
                <div>
                    <div class="toggle-label">üîê Append API Key to URLs</div>
                    <div class="toggle-description" id="keyDesc">URLs will be fetched with your API key appended. Disable for public/end-of-life URLs that don't require authentication.</div>
                </div>
            </div>

            <div class="section">
                <label for="corsProxyUrl">üåê CORS Proxy URL (Optional)</label>
                <input type="url" id="corsProxyUrl" placeholder="https://thingproxy.freeboard.io/fetch/">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Required for Catbox uploads from GitHub Pages due to CORS restrictions. 
                    Try: <code>https://thingproxy.freeboard.io/fetch/</code> or <code>https://api.allorigins.win/raw?url=</code>
                </small>
            </div>

            <div class="toggle-container">
                <div class="toggle-switch active" id="catboxToggle" onclick="toggleCatbox()">
                    <div class="toggle-slider"></div>
                </div>
                <div>
                    <div class="toggle-label">‚òÅÔ∏è Upload to Catbox.moe (Permanent Links)</div>
                    <div class="toggle-description" id="catboxDesc">Images will be uploaded to Catbox for permanent hosting. Disable this to download images locally instead (bypasses CORS issues).</div>
                </div>
            </div>

            <div class="info-box" id="localModeInfo" style="display: none;">
                <strong>üíª Local Download Mode Active:</strong> Images will be downloaded to your computer instead of uploaded to Catbox. 
                Use the "Download All as ZIP" button when complete to save all images at once.
            </div>

            <div class="section">
                <label>üìÑ Upload File (JSON, TXT, HTML)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".json,.txt,.csv,.html,.htm" onchange="handleFileSelect(event)">
                    <label for="fileInput" class="file-input-label" id="fileLabel">
                        <div style="font-size: 24px; margin-bottom: 10px;">üì§</div>
                        <div>Drop file here or click to upload</div>
                        <div style="font-size: 12px; color: #a0aec0; margin-top: 5px;">Supports .json, .txt, .csv, .html</div>
                    </label>
                </div>
                <div id="fileInfo" style="margin-top: 10px; color: #48bb78; font-weight: 600; display: none;">
                    ‚úì File loaded: <span id="fileName"></span> (<span id="urlCount">0</span> URLs found)
                </div>
            </div>

            <div class="section" id="controlSection" style="display: none;">
                <button class="btn" onclick="startBulkProcessing()" id="startBtn">
                    ‚ñ∂Ô∏è Start Processing
                </button>
                <button class="btn btn-danger" onclick="stopProcessing()" id="stopBtn" style="display: none;">
                    ‚èπ Stop
                </button>
                <button class="btn btn-warning" onclick="downloadAllAsZip()" id="downloadZipBtn" style="display: none; margin-left: 10px;">
                    üì¶ Download All as ZIP
                </button>
                <button class="btn btn-secondary" onclick="regenerateExport()" id="refreshExportBtn" style="display: none; margin-left: 10px;">
                    üîÑ Refresh Export
                </button>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText"></div>

            <div class="stats" id="statsSection" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Total URLs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statSuccess">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statFailed">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statPending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>

            <div id="resultsTable" style="display: none; overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Preview</th>
                            <th>Original Pollinations URL</th>
                            <th>New Catbox URL</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="output-section" id="outputSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label>üìã Export Data (Updates Automatically)</label>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="downloadJSON()" style="margin-right: 5px;">üíæ JSON</button>
                        <button class="btn btn-secondary btn-small" onclick="downloadTXT()">üìù TXT</button>
                    </div>
                </div>
                <div class="relative">
                    <button class="copy-btn" onclick="copyOutput()">üìã Copy All</button>
                    <div class="json-output" id="jsonOutput"></div>
                </div>
            </div>
        </div>

        <!-- SINGLE LINK TAB -->
        <div id="single" class="content">
            <div class="section">
                <label for="singleApiKey">üîë Pollinations.ai API Key (Optional)</label>
                <input type="password" id="singleApiKey" placeholder="Enter your API key if needed...">
            </div>

            <div class="toggle-container" style="margin-bottom: 20px;">
                <div class="toggle-switch active" id="singleKeyToggle" onclick="toggleSingleKeyAppend()">
                    <div class="toggle-slider"></div>
                </div>
                <div>
                    <div class="toggle-label">üîê Append API Key to URL</div>
                    <div class="toggle-description" id="singleKeyDesc">Fetch with API key appended. Disable for public URLs.</div>
                </div>
            </div>

            <div class="section">
                <label for="singleCorsProxy">üåê CORS Proxy URL (Optional)</label>
                <input type="url" id="singleCorsProxy" placeholder="https://thingproxy.freeboard.io/fetch/">
                <small style="color: #718096; display: block; margin-top: 5px;">
                    Required for Catbox uploads from GitHub Pages. Example: <code>https://thingproxy.freeboard.io/fetch/</code>
                </small>
            </div>

            <div class="toggle-container" style="margin-bottom: 20px;">
                <div class="toggle-switch active" id="singleCatboxToggle" onclick="toggleSingleCatbox()">
                    <div class="toggle-slider"></div>
                </div>
                <div>
                    <div class="toggle-label">‚òÅÔ∏è Enable Catbox.moe Upload</div>
                    <div class="toggle-description" id="singleCatboxDesc">Upload to Catbox for a permanent link. Disable to download locally (no CORS issues).</div>
                </div>
            </div>

            <div class="section">
                <label for="singleUrl">üîó Pollinations Image URL</label>
                <textarea id="singleUrl" placeholder="Paste your Pollinations.ai image URL here..."></textarea>
            </div>

            <div class="section">
                <button class="btn" onclick="processSingle()" id="singleBtn">
                    üöÄ Process Image
                </button>
            </div>

            <div id="singleResult" style="display: none; margin-top: 30px;">
                <div class="section">
                    <label>üñºÔ∏è Generated Image Preview</label>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
                        <img id="singlePreview" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    </div>
                </div>

                <div class="section">
                    <label>üîó Original Pollinations URL (Cleaned)</label>
                    <input type="text" id="singleOriginalDisplay" readonly style="width: 100%; font-family: monospace; font-size: 12px;">
                </div>

                <div class="section" id="singleCatboxResult">
                    <label>üîó Permanent Catbox.moe Link</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="singleOutput" readonly style="flex: 1; font-family: monospace;">
                        <button class="btn btn-secondary" onclick="copySingle()">üìã Copy</button>
                    </div>
                </div>

                <div class="section" id="singleLocalResult" style="display: none;">
                    <label>üíæ Download Image</label>
                    <a id="singleDownloadLink" class="btn btn-secondary" download="image.png" style="text-decoration: none; display: inline-block;">
                        ‚¨áÔ∏è Download Image
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let urls = [];
        let results = [];
        let imageBlobs = [];
        let isProcessing = false;
        let shouldStop = false;
        let currentIndex = 0;
        let useCatbox = true;
        let appendApiKey = true;
        let singleUseCatbox = true;
        let singleAppendApiKey = true;
        let corsErrorDetected = false;
        let originalFileName = '';

        // Initialize
        window.onload = function() {
            const savedKey = localStorage.getItem('pollinations_api_key');
            const savedProxy = localStorage.getItem('cors_proxy_url');
            
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('singleApiKey').value = savedKey;
            }
            if (savedProxy) {
                document.getElementById('corsProxyUrl').value = savedProxy;
                document.getElementById('singleCorsProxy').value = savedProxy;
            }
            
            setupDragAndDrop();
        };

        // Drag and Drop Setup
        function setupDragAndDrop() {
            const dropZone = document.getElementById('fileLabel');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropZone.classList.add('drag-active');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('drag-active');
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Save settings on input
        document.getElementById('apiKey').addEventListener('input', function(e) {
            localStorage.setItem('pollinations_api_key', e.target.value);
            document.getElementById('singleApiKey').value = e.target.value;
        });

        document.getElementById('singleApiKey').addEventListener('input', function(e) {
            localStorage.setItem('pollinations_api_key', e.target.value);
            document.getElementById('apiKey').value = e.target.value;
        });

        document.getElementById('corsProxyUrl').addEventListener('input', function(e) {
            localStorage.setItem('cors_proxy_url', e.target.value);
            document.getElementById('singleCorsProxy').value = e.target.value;
        });

        document.getElementById('singleCorsProxy').addEventListener('input', function(e) {
            localStorage.setItem('cors_proxy_url', e.target.value);
            document.getElementById('corsProxyUrl').value = e.target.value;
        });

        function toggleKeyAppend() {
            appendApiKey = !appendApiKey;
            const toggle = document.getElementById('keyToggle');
            const desc = document.getElementById('keyDesc');
            
            if (appendApiKey) {
                toggle.classList.add('active');
                desc.textContent = 'URLs will be fetched with your API key appended. Required for private/restricted images.';
            } else {
                toggle.classList.remove('active');
                desc.textContent = 'URLs will be fetched WITHOUT API key. Use for public/end-of-life URLs that do not require authentication.';
            }
        }

        function toggleCatbox() {
            useCatbox = !useCatbox;
            const toggle = document.getElementById('catboxToggle');
            const desc = document.getElementById('catboxDesc');
            const info = document.getElementById('localModeInfo');
            const corsWarning = document.getElementById('corsWarning');
            
            if (useCatbox) {
                toggle.classList.add('active');
                desc.textContent = 'Images will be uploaded to Catbox for permanent hosting. Requires CORS proxy when running on GitHub Pages.';
                info.style.display = 'none';
                if (corsErrorDetected) corsWarning.style.display = 'block';
            } else {
                toggle.classList.remove('active');
                desc.textContent = 'Images will be saved locally to your computer. No CORS issues, but you get a ZIP file instead of URLs.';
                info.style.display = 'block';
                corsWarning.style.display = 'none';
            }
        }

        function toggleSingleKeyAppend() {
            singleAppendApiKey = !singleAppendApiKey;
            const toggle = document.getElementById('singleKeyToggle');
            const desc = document.getElementById('singleKeyDesc');
            
            if (singleAppendApiKey) {
                toggle.classList.add('active');
                desc.textContent = 'Fetch with API key appended. Required for private/restricted images.';
            } else {
                toggle.classList.remove('active');
                desc.textContent = 'Fetch WITHOUT API key. Use for public URLs.';
            }
        }

        function toggleSingleCatbox() {
            singleUseCatbox = !singleUseCatbox;
            const toggle = document.getElementById('singleCatboxToggle');
            const desc = document.getElementById('singleCatboxDesc');
            
            if (singleUseCatbox) {
                toggle.classList.add('active');
                desc.textContent = 'Upload to Catbox for a permanent link. Requires CORS proxy on GitHub Pages.';
            } else {
                toggle.classList.remove('active');
                desc.textContent = 'Download image directly to your computer (no CORS issues).';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'bulk') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('bulk').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('single').classList.add('active');
            }
        }

        function processFile(file) {
            originalFileName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                urls = extractUrls(content, file.name);
                
                urls = [...new Set(urls)];
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('urlCount').textContent = urls.length;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('controlSection').style.display = urls.length > 0 ? 'block' : 'none';
                document.getElementById('refreshExportBtn').style.display = 'none';
                
                if (urls.length === 0) {
                    alert('No Pollinations.ai URLs found in file. Please check the format.');
                } else {
                    console.log(`Found ${urls.length} unique URLs`);
                }
            };
            reader.readAsText(file);
        }

        function extractUrls(content, filename) {
            const pollinationsRegex = /https?:\/\/[^"'\s<>]+pollinations\.ai[^"'\s<>]*/gi;
            let urls = [];
            
            if (filename && (filename.endsWith('.json') || filename.endsWith('.JSON'))) {
                try {
                    const json = JSON.parse(content);
                    
                    function findUrlsRecursive(obj) {
                        if (typeof obj === 'string') {
                            const matches = obj.match(pollinationsRegex);
                            if (matches) {
                                matches.forEach(url => urls.push(stripApiKey(url)));
                            }
                        } else if (Array.isArray(obj)) {
                            obj.forEach(item => findUrlsRecursive(item));
                        } else if (typeof obj === 'object' && obj !== null) {
                            Object.values(obj).forEach(val => findUrlsRecursive(val));
                        }
                    }
                    
                    findUrlsRecursive(json);
                    
                    if (urls.length > 0) {
                        return urls;
                    }
                } catch (e) {
                    console.log('JSON parse failed, falling back to regex');
                }
            }
            
            const matches = content.match(pollinationsRegex) || [];
            urls = matches.map(url => stripApiKey(url));
            
            return urls;
        }

        function stripApiKey(url) {
            try {
                const urlObj = new URL(url);
                urlObj.searchParams.delete('key');
                if (urlObj.search === '') {
                    return urlObj.toString().replace('?', '');
                }
                return urlObj.toString();
            } catch (e) {
                return url.replace(/([?&])key=[^&]+(&|$)/g, '$1').replace(/&$/, '').replace(/\?$/, '');
            }
        }

        async function startBulkProcessing() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (appendApiKey && !apiKey) {
                alert('Please enter your API key first, or disable "Append API Key to URLs" toggle if not needed!');
                return;
            }

            if (urls.length === 0) {
                alert('No URLs to process!');
                return;
            }

            // Reset CORS error flag
            corsErrorDetected = false;
            document.getElementById('corsWarning').style.display = 'none';

            isProcessing = true;
            shouldStop = false;
            currentIndex = 0;
            results = new Array(urls.length).fill(null);
            imageBlobs = new Array(urls.length).fill(null);

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-flex';
            document.getElementById('progressBar').classList.add('active');
            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('resultsTable').style.display = 'block';
            document.getElementById('outputSection').classList.remove('active');
            document.getElementById('downloadZipBtn').style.display = 'none';
            document.getElementById('refreshExportBtn').style.display = 'none';

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            urls.forEach((url, index) => {
                const row = document.createElement('tr');
                row.id = `row-${index}`;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td id="preview-${index}">-</td>
                    <td class="url-cell original-url" title="${url}" onclick="window.open('${url}', '_blank')">${truncateUrl(url, 40)}</td>
                    <td id="catbox-url-${index}" class="url-cell">-</td>
                    <td id="status-${index}"><span class="status-badge status-pending">Pending</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-small" onclick="retrySingle(${index})" id="retry-${index}" style="display: none;">üîÑ Retry</button>
                        ${!useCatbox ? `<a id="download-${index}" class="btn btn-small btn-secondary" style="display: none; text-decoration: none;">‚¨áÔ∏è Save</a>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateStats();

            for (let i = 0; i < urls.length; i++) {
                if (shouldStop) break;
                
                currentIndex = i;
                await processUrl(i, urls[i], apiKey);
                
                const progress = ((i + 1) / urls.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('statusText').textContent = `Processing ${i + 1} of ${urls.length}... ( delays: 1-5s )`;
                
                updateStats();
            }

            isProcessing = false;
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('statusText').textContent = shouldStop ? 'Stopped by user' : 'Complete!';
            
            if (!shouldStop || results.some(r => r && r.success)) {
                generateOutput();
                document.getElementById('outputSection').classList.add('active');
                document.getElementById('refreshExportBtn').style.display = 'inline-flex';
                
                if (!useCatbox) {
                    document.getElementById('downloadZipBtn').style.display = 'inline-flex';
                }
            }

            // Show CORS warning if we detected errors
            if (corsErrorDetected && useCatbox) {
                document.getElementById('corsWarning').style.display = 'block';
            }
        }

        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength) + '...';
        }

        function stopProcessing() {
            shouldStop = true;
            document.getElementById('statusText').textContent = 'Stopping...';
        }

        async function processUrl(index, originalUrl, apiKey) {
            const statusCell = document.getElementById(`status-${index}`);
            const previewCell = document.getElementById(`preview-${index}`);
            const catboxCell = document.getElementById(`catbox-url-${index}`);
            const retryBtn = document.getElementById(`retry-${index}`);
            const corsProxyUrl = document.getElementById('corsProxyUrl').value.trim();

            try {
                statusCell.innerHTML = '<span class="status-badge status-processing">Fetching...</span>';

                // Conditionally append API key
                let fetchUrl = originalUrl;
                if (appendApiKey && apiKey) {
                    const separator = originalUrl.includes('?') ? '&' : '?';
                    fetchUrl = `${originalUrl}${separator}key=${encodeURIComponent(apiKey)}`;
                }
                
                console.log(`[${index + 1}] Fetching: ${appendApiKey ? 'WITH' : 'WITHOUT'} API key`);

                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const blob = await response.blob();
                console.log(`[${index + 1}] Image fetched, size: ${blob.size} bytes`);
                
                imageBlobs[index] = blob;

                const imgUrl = URL.createObjectURL(blob);
                previewCell.innerHTML = `<img src="${imgUrl}" class="preview-img" onclick="window.open('${imgUrl}', '_blank')">`;

                // Staggered delay
                const delay = 1000 + Math.random() * 4000;
                console.log(`[${index + 1}] Waiting ${(delay/1000).toFixed(1)}s before upload...`);
                await new Promise(resolve => setTimeout(resolve, delay));

                if (useCatbox) {
                    statusCell.innerHTML = '<span class="status-badge status-processing">Uploading...</span>';
                    console.log(`[${index + 1}] Uploading to Catbox...`);
                    
                    // Check if we have a CORS proxy configured
                    if (!corsProxyUrl) {
                        console.warn(`[${index + 1}] No CORS proxy configured. This may fail on GitHub Pages.`);
                    }
                    
                    const catboxUrl = await uploadToCatbox(blob, `image_${index + 1}.png`, corsProxyUrl);
                    
                    if (catboxUrl.startsWith('Error')) {
                        if (catboxUrl.includes('CORS')) {
                            corsErrorDetected = true;
                        }
                        throw new Error(catboxUrl);
                    }

                    console.log(`[${index + 1}] Catbox URL: ${catboxUrl}`);

                    results[index] = {
                        original: originalUrl,
                        catbox: catboxUrl,
                        success: true,
                        local: false,
                        timestamp: new Date().toISOString()
                    };

                    statusCell.innerHTML = '<span class="status-badge status-success">Success</span>';
                    catboxCell.innerHTML = `<a href="${catboxUrl}" target="_blank" class="url-cell" title="${catboxUrl}">${truncateUrl(catboxUrl, 35)}</a>`;
                } else {
                    const downloadUrl = URL.createObjectURL(blob);
                    const downloadBtn = document.getElementById(`download-${index}`);
                    if (downloadBtn) {
                        downloadBtn.href = downloadUrl;
                        downloadBtn.download = `image_${String(index + 1).padStart(3, '0')}.png`;
                        downloadBtn.style.display = 'inline-flex';
                    }
                    
                    results[index] = {
                        original: originalUrl,
                        local: true,
                        success: true,
                        filename: `image_${String(index + 1).padStart(3, '0')}.png`,
                        timestamp: new Date().toISOString()
                    };

                    statusCell.innerHTML = '<span class="status-badge status-success">Ready</span>';
                    catboxCell.innerHTML = `<a href="${downloadUrl}" download="image_${String(index + 1).padStart(3, '0')}.png" class="download-link">‚¨áÔ∏è Download</a>`;
                }
                
                retryBtn.style.display = 'none';

            } catch (error) {
                console.error(`[${index + 1}] Error:`, error);
                
                results[index] = {
                    original: originalUrl,
                    error: error.message,
                    success: false,
                    timestamp: new Date().toISOString()
                };

                statusCell.innerHTML = `<span class="status-badge status-error" title="${error.message}">Failed</span>`;
                catboxCell.textContent = 'Error';
                catboxCell.style.color = '#991b1b';
                retryBtn.style.display = 'inline-block';
            }
        }

        async function retrySingle(index) {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (appendApiKey && !apiKey) {
                alert('API key required! Either enter a key or disable "Append API Key".');
                return;
            }
            
            await processUrl(index, urls[index], apiKey);
            updateStats();
            
            generateOutput();
            
            if (results.some(r => r && r.success)) {
                document.getElementById('outputSection').classList.add('active');
                document.getElementById('refreshExportBtn').style.display = 'inline-flex';
            }
            
            const allDone = results.every(r => r && r.success);
            if (allDone && !useCatbox) {
                document.getElementById('downloadZipBtn').style.display = 'inline-flex';
            }
        }

        function regenerateExport() {
            generateOutput();
            document.getElementById('outputSection').classList.add('active');
            alert('Export list refreshed with current results!');
        }

        async function uploadToCatbox(blob, filename, corsProxyUrl) {
            const formData = new FormData();
            formData.append('reqtype', 'fileupload');
            formData.append('fileToUpload', blob, filename);

            const catboxApiUrl = 'https://catbox.moe/user/api.php';
            
            // Construct URL based on whether we have a CORS proxy
            let targetUrl;
            if (corsProxyUrl) {
                // Format: proxyUrl + encodeURIComponent(targetUrl) or proxyUrl + targetUrl
                // thingproxy style: https://thingproxy.freeboard.io/fetch/https://catbox.moe/user/api.php
                // corsproxy.io style: https://corsproxy.io/?url=https://catbox.moe/user/api.php
                if (corsProxyUrl.includes('?')) {
                    // Query parameter style (corsproxy.io)
                    targetUrl = `${corsProxyUrl}${encodeURIComponent(catboxApiUrl)}`;
                } else {
                    // Path style (thingproxy)
                    targetUrl = `${corsProxyUrl}${catboxApiUrl}`;
                }
            } else {
                targetUrl = catboxApiUrl;
            }

            try {
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Catbox HTTP ${response.status}`);
                }

                const text = await response.text();
                
                if (text.includes('http')) {
                    return text.trim();
                } else {
                    throw new Error(text);
                }
            } catch (error) {
                console.error('Catbox upload error:', error);
                
                if (error.message.includes('Failed to fetch') || 
                    error.message.includes('CORS') || 
                    error.message.includes('NetworkError')) {
                    return 'Error: CORS or Network Error. Direct uploads to Catbox from GitHub Pages are blocked by browsers. Solutions: 1) Enter a CORS Proxy URL above, 2) Disable Catbox toggle to download locally instead, or 3) Run this app on localhost.';
                }
                return `Error: ${error.message}`;
            }
        }

        async function downloadAllAsZip() {
            if (!imageBlobs.some(b => b !== null)) {
                alert('No images to download!');
                return;
            }

            const btn = document.getElementById('downloadZipBtn');
            btn.disabled = true;
            btn.textContent = 'Creating ZIP...';

            try {
                const zip = new JSZip();
                const folder = zip.folder("pollinations_images");
                
                let count = 0;
                imageBlobs.forEach((blob, index) => {
                    if (blob) {
                        const filename = `image_${String(index + 1).padStart(3, '0')}.png`;
                        folder.file(filename, blob);
                        count++;
                    }
                });

                const content = await zip.generateAsync({type: "blob"});
                saveAs(content, "pollinations_images.zip");
                
                console.log(`ZIP created with ${count} images`);
            } catch (error) {
                console.error('Error creating ZIP:', error);
                alert('Error creating ZIP file. Try downloading images individually.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì¶ Download All as ZIP';
            }
        }

        function updateStats() {
            const total = urls.length;
            const success = results.filter(r => r && r.success).length;
            const failed = results.filter(r => r && !r.success).length;
            const pending = total - success - failed;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statSuccess').textContent = success;
            document.getElementById('statFailed').textContent = failed;
            document.getElementById('statPending').textContent = pending;
        }

        function generateOutput() {
            let output;
            
            if (useCatbox) {
                output = results.map((r, i) => {
                    if (r && r.success) {
                        return {
                            index: i + 1,
                            original_url: r.original,
                            catbox_url: r.catbox,
                            status: 'success'
                        };
                    } else if (r) {
                        return {
                            index: i + 1,
                            original_url: r.original,
                            error: r.error,
                            status: 'failed'
                        };
                    }
                    return {
                        index: i + 1,
                        original_url: urls[i] || 'unknown',
                        status: 'pending'
                    };
                });
            } else {
                output = results.map((r, i) => {
                    if (r && r.success) {
                        return {
                            index: i + 1,
                            original_url: r.original,
                            local_filename: r.filename,
                            status: 'downloaded_locally'
                        };
                    } else if (r) {
                        return {
                            index: i + 1,
                            original_url: r.original,
                            error: r.error,
                            status: 'failed'
                        };
                    }
                    return {
                        index: i + 1,
                        original_url: urls[i] || 'unknown',
                        status: 'pending'
                    };
                });
            }
            
            document.getElementById('jsonOutput').textContent = JSON.stringify(output, null, 2);
        }

        function downloadJSON() {
            const dataStr = document.getElementById('jsonOutput').textContent;
            const filename = originalFileName ? 
                originalFileName.replace(/\.[^/.]+$/, '') + '_converted.json' : 
                'pollinations_converted.json';
            downloadFile(dataStr, filename, 'application/json');
        }

        function downloadTXT() {
            let lines = [];
            
            results.forEach((r, i) => {
                if (r && r.success) {
                    if (useCatbox) {
                        lines.push(`${r.catbox}`);
                    } else {
                        lines.push(`${r.filename} | ${r.original}`);
                    }
                } else if (r) {
                    lines.push(`# FAILED [${i+1}]: ${r.original} - Error: ${r.error}`);
                }
            });
            
            const dataStr = lines.join('\n');
            const filename = originalFileName ? 
                originalFileName.replace(/\.[^/.]+$/, '') + '_converted.txt' : 
                'pollinations_converted.txt';
            downloadFile(dataStr, filename, 'text/plain');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyOutput() {
            const content = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            });
        }

        async function processSingle() {
            const apiKey = document.getElementById('singleApiKey').value.trim();
            const url = document.getElementById('singleUrl').value.trim();
            const corsProxyUrl = document.getElementById('singleCorsProxy').value.trim();
            
            if (!url) {
                alert('Please enter a URL!');
                return;
            }

            if (singleAppendApiKey && !apiKey) {
                alert('Please enter your API key, or disable "Append API Key to URL" if not needed!');
                return;
            }

            const btn = document.getElementById('singleBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const cleanUrl = stripApiKey(url);
                
                let fetchUrl = url;
                if (singleAppendApiKey && apiKey) {
                    const separator = url.includes('?') ? '&' : '?';
                    fetchUrl = `${url}${separator}key=${encodeURIComponent(apiKey)}`;
                }
                
                console.log('Fetching:', singleAppendApiKey ? 'WITH' : 'WITHOUT', 'API key');
                const response = await fetch(fetchUrl);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const blob = await response.blob();
                console.log('Image fetched');
                
                const delay = 1000 + Math.random() * 4000;
                await new Promise(resolve => setTimeout(resolve, delay));
                
                const imgUrl = URL.createObjectURL(blob);
                document.getElementById('singlePreview').src = imgUrl;
                document.getElementById('singleOriginalDisplay').value = cleanUrl;
                document.getElementById('singleResult').style.display = 'block';
                
                if (singleUseCatbox) {
                    if (!corsProxyUrl) {
                        console.warn('No CORS proxy configured for single upload');
                    }
                    const catboxUrl = await uploadToCatbox(blob, 'image.png', corsProxyUrl);
                    if (catboxUrl.startsWith('Error')) throw new Error(catboxUrl);
                    
                    document.getElementById('singleOutput').value = catboxUrl;
                    document.getElementById('singleCatboxResult').style.display = 'block';
                    document.getElementById('singleLocalResult').style.display = 'none';
                    console.log('Catbox success:', catboxUrl);
                } else {
                    const downloadLink = document.getElementById('singleDownloadLink');
                    downloadLink.href = imgUrl;
                    downloadLink.download = 'pollinations_image.png';
                    document.getElementById('singleCatboxResult').style.display = 'none';
                    document.getElementById('singleLocalResult').style.display = 'block';
                    console.log('Local download ready');
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                if (error.message.includes('CORS')) {
                    alert('CORS Error: ' + error.message + '\n\nTry entering a CORS Proxy URL or disable Catbox upload to download locally.');
                } else {
                    alert('Error: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Process Image';
            }
        }

        function copySingle() {
            const val = document.getElementById('singleOutput');
            val.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }
    </script>
</body>
</html>
