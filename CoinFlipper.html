<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Multi-Coin Flip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background-color: #0f0f0f; color: white; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        #canvas-container { width: 100%; height: 380px; background: #87CEEB; touch-action: none; border-bottom: 3px solid #d4af37; position: relative; }
        
        /* Settings Gear */
        #settingsBtn { position: absolute; top: 15px; right: 15px; font-size: 28px; cursor: pointer; z-index: 100; transition: transform 0.3s; color: #d4af37; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #settingsBtn:hover { transform: rotate(90deg); }

        /* Modal / Menu */
        #settingsMenu { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .menu-content { max-width: 600px; margin: 0 auto; background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid #d4af37; }
        .close-menu { float: right; font-size: 30px; cursor: pointer; color: #888; }
        
        /* Collapsible Sections */
        .collapsible {
            background-color: #222;
            color: #d4af37;
            cursor: pointer;
            padding: 12px 15px;
            width: 100%;
            border: 1px solid #333;
            text-align: left;
            outline: none;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible:after { content: '\002B'; font-size: 1.2rem; }
        .collapsible.active:after { content: "\2212"; }
        .collapsible-content {
            padding: 0 15px;
            display: none;
            overflow: hidden;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
        }

        .section-title { color: #d4af37; border-bottom: 1px solid #333; margin: 20px 0 10px 0; padding-bottom: 5px; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }
        .input-group { margin-bottom: 15px; text-align: left; margin-top: 15px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #bbb; }
        .input-group input[type="text"], .input-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; }
        
        /* Previews */
        .preview-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; margin-top: 10px; }
        .img-preview-wrapper { position: relative; width: 60px; height: 60px; }
        .img-preview { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #d4af37; object-fit: cover; background: #333; }
        #surfacePreviewCanvas { width: 100%; height: 50px; border-radius: 4px; border: 1px solid #444; margin-top: 10px; display: block; }

        /* AI Spinners */
        .spinner { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #d4af37; border-radius: 50%; width: 14px; height: 14px; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-left: 8px; visibility: hidden; }
        .img-spinner { position: absolute; top: 22px; left: 22px; width: 16px; height: 16px; visibility: hidden; z-index: 5; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AI Section Styles */
        .ai-gen-container { padding: 10px; background: #111; border: 1px dashed #444; border-radius: 8px; margin-bottom: 15px; }
        .ai-row { display: flex; gap: 5px; margin-top: 5px; }
        .ai-row button { flex: 1; padding: 6px; font-size: 0.65rem; }

        /* Preset Coin List */
        .preset-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px 5px; }
        .preset-item { display: flex; align-items: center; background: #222; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; border: 1px solid transparent; }
        .preset-item:hover { background: #333; border-color: #d4af37; }
        .preset-imgs { display: flex; gap: 5px; margin-right: 15px; }
        .preset-imgs img { width: 50px; height: 50px; border-radius: 50%; border: 1px solid #444; object-fit: cover; }
        .preset-name { font-weight: bold; font-size: 0.9rem; }

        /* UI Elements */
        .ui { width: 95%; max-width: 850px; padding: 15px; box-sizing: border-box; }
        .controls-card { background: #1a1a1a; border-radius: 15px; padding: 20px; border: 1px solid #333; box-shadow: 0 15px 35px rgba(0,0,0,0.7); text-align: center; }
        h2 { margin: 0 0 10px 0; color: #d4af37; letter-spacing: 1px; font-size: 1.5rem; }
        label { color:#bbb; font-size: 0.9rem; font-weight: bold; }
        input[type="number"] { padding: 10px; width: 80px; border-radius: 8px; border: 1px solid #d4af37; background: #000; color: #d4af37; font-size: 18px; text-align: center; outline: none; margin: 5px; }
        .btn-group { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; text-transform: uppercase; font-size: 0.85rem; }
        .flip-btn { background: #d4af37; color: #000; }
        .flip-btn:hover:not(:disabled) { background: #f1c40f; transform: translateY(-2px); }
        .flip-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        .secondary-btn { background: #34495e; color: white; }
        
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; background: #fff; color: #000; min-width: 380px; }
        th { background: #d4af37; color: #000; padding: 12px 5px; font-size: 11px; text-transform: uppercase; }
        td { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: center; font-size: 16px; font-weight: 600; vertical-align: middle; }
        .pct { font-size: 0.7em; color: #777; display: block; font-weight: normal; margin-top: 2px; }
        .total-row { background: #f9f1d7; font-weight: bold; border-top: 3px solid #d4af37; }
        .instruction { color: #888; font-size: 11px; margin-top: 10px; font-style: italic; }

        @media (max-width: 480px) {
            td { font-size: 14px; padding: 8px 4px; }
            h2 { font-size: 1.2rem; }
            button { padding: 10px 15px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div id="canvas-container">
    <div id="settingsBtn">⚙️</div>
</div>

<!-- SETTINGS MENU -->
<div id="settingsMenu">
    <div class="menu-content">
        <span class="close-menu" id="closeSettings">&times;</span>
        <h3 style="margin-top:0; color:#d4af37">COIN SETTINGS</h3>
        
        <button class="collapsible">Table Surface</button>
        <div class="collapsible-content">
            <div class="input-group">
                <label>Surface Type:</label>
                <select id="tableSurfaceSelect">
                    <option value="standard">Standard Dark</option>
                    <option value="red-felt">Red Felt</option>
                    <option value="blue-felt">Blue Felt</option>
                    <option value="purple-felt">Purple Felt</option>
                    <option value="green-felt">Green Felt</option>
                    <option value="wood" Selected>Wood</option>
                    <option value="steel">Steel</option>
                    <option value="dirt">Dirt</option>
                </select>
                <canvas id="surfacePreviewCanvas"></canvas>
            </div>
        </div>

        <button class="collapsible">Customizable Section</button>
        <div class="collapsible-content">
            <!-- AI Generation Tool -->
            <button class="collapsible" style="font-size: 0.75rem; background: #111;">AI Generation Tools</button>
            <div class="collapsible-content">
                <div class="ai-gen-container">
                    <label style="font-size: 0.7rem; color: #d4af37;">FRONT (HEADS) PROMPT <div id="spinTextHeads" class="spinner"></div></label>
                    <input type="text" id="aiHeadsPrompt" placeholder="Describe the front side..." style="width:100%; padding:5px; background:#000; color:#fff; border:1px solid #444; font-size: 0.8rem;">
                    <div class="ai-row">
                        <button id="genHeadsBtn" class="flip-btn">Generate</button>
                        <button id="regenHeadsBtn" class="secondary-btn">Regenerate</button>
                        <button id="randHeadsBtn" class="secondary-btn">Randomizer</button>
                    </div>
                </div>
                <div class="ai-gen-container">
                    <label style="font-size: 0.7rem; color: #d4af37;">BACK (TAILS) PROMPT <div id="spinTextTails" class="spinner"></div></label>
                    <input type="text" id="aiTailsPrompt" placeholder="Describe the back side..." style="width:100%; padding:5px; background:#000; color:#fff; border:1px solid #444; font-size: 0.8rem;">
                    <div class="ai-row">
                        <button id="genTailsBtn" class="flip-btn">Generate</button>
                        <button id="regenTailsBtn" class="secondary-btn">Regenerate</button>
                        <button id="randTailsBtn" class="secondary-btn">Randomizer</button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>Heads Image URL:</label>
                <input type="text" id="headsUrlInput" placeholder="Paste image link here...">
            </div>
            <div class="input-group">
                <label>Tails Image URL:</label>
                <input type="text" id="tailsUrlInput" placeholder="Paste image link here...">
            </div>
            <div class="input-group">
                <label>Or Upload Files:</label>
                <input type="file" id="headsFile" accept="image/*" style="margin-bottom:5px">
                <input type="file" id="tailsFile" accept="image/*">
            </div>
            <div class="preview-container">
                <div class="img-preview-wrapper">
                    <div style="font-size:10px; text-align:center; color:#888">HEADS</div>
                    <div id="spinImgHeads" class="spinner img-spinner"></div>
                    <img id="headsPreview" class="img-preview" src="">
                </div>
                <div class="img-preview-wrapper">
                    <div style="font-size:10px; text-align:center; color:#888">TAILS</div>
                    <div id="spinImgTails" class="spinner img-spinner"></div>
                    <img id="tailsPreview" class="img-preview" src="">
                </div>
            </div>
            <button id="applyCustom" class="flip-btn" style="width:100%; margin-bottom:10px">Apply Custom Images</button>
            <button id="clearCustomFields" class="secondary-btn" style="width:100%; margin-bottom:15px">Clear Custom Fields</button>
        </div>

        <button class="collapsible">Choose a Coin Preset</button>
        <div class="collapsible-content">
            <div class="preset-list" id="presetList">
                <!-- Items injected via JS -->
            </div>
        </div>
    </div>
</div>

<div class="ui">
    <div class="controls-card">
        <h2>COIN FLIPPER</h2>
        <label>COINS: </label>
        <input type="number" id="coinCountInput" value="1" min="1" max="25">
        <label>FLIPS: </label>
        <input type="number" id="flipCount" value="1" min="1">
        
        <div class="btn-group">
            <button id="flipBtn" class="flip-btn">Flip Coin</button>
            <button id="stopBtn" class="secondary-btn">Stop</button>
            <button id="nextRoundBtn" class="secondary-btn">New Round</button>
            <button id="resetBtn" class="secondary-btn">Reset Board</button>
        </div>
        <p class="instruction">Drag: Rotate | Scroll/Pinch: Zoom | Percentage tracks per round.</p>
    </div>

    <div class="table-container">
        <table id="tallyTable">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Heads (Face)</th>
                    <th>Tails (Back)</th>
                    <th>Round Total</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td>GRAND</td>
                    <td><span id="gh">0</span><span id="ghp" class="pct">0.0%</span></td>
                    <td><span id="gt">0</span><span id="gtp" class="pct">0.0%</span></td>
                    <td id="gall">0</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    /** PRESET DATA **/
    const COIN_PRESETS = [
{
    name: "Jazz Animals Coin",
    front: "https://enter.pollinations.ai/api/generate/image/%22A%20whimsical%20coin%20relief%20showcases%20a%20doodle-style%20sun%20serenading%20a%20jazz%20band%20of%20friendly%20animals.%22?model=flux&seed=918171424&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22A%20whimsical%20coin%20relief%20showcases%20a%20doodle-style%20sun%20serenading%20a%20jazz%20band%20of%20friendly%20animals.%22?model=flux&seed=289078645&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
{
    name: "Peacock Coin",
    front: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20coin%20featuring%20an%20abstracted%2C%20swirling%20pattern%20of%20intertwining%20peacock%20feathers%2C%20it's%20head%20showing%20through%20the%20feathers%2C%2C%20a%20fusion%20of%20abstract%20art%20with%20rich%2C%20iridescent%20details.%22?model=flux&seed=264105919&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20coin%20featuring%20an%20abstracted%2C%20swirling%20pattern%20of%20intertwining%20peacock%20feathers%2C%20a%20fusion%20of%20abstract%20art%20with%20rich%2C%20iridescent%20details.%22?model=flux&seed=738515044&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
{
    name: "Whimsical",
    front: "https://enter.pollinations.ai/api/generate/image/%22A%20whimsical%20coin%20relief%20features%20an%20abstract%20fusion%20of%20spiraled%20floral%20patterns%20and%20delicate%20celestial%20motifs.%22?model=flux&seed=267479303&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20swirling%2C%20abstract%20patterns%20reminiscent%20of%20ancient%20sea%20shells%2C%20masterfully%20rendered%20in%20high-relief%20on%20your%20coin.%22?model=flux&seed=350072678&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
{
    name: "Hatsune Miku Coin",
    front: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20coin%20featuring%20Hatsune%20Miku%20Dancing%20on%20stage.%20Do%20not%20include%20any%20words%22?model=flux&seed=760957183&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20coin%20featuring%20Hatsune%20Miku%20from%20behind%20dancing%20on%20stage.%20Do%20not%20include%20any%20words%22?model=flux&seed=313833201&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
{
    name: "Girl Coin",
    front: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20closeup%20of%20a%20coin%20featuring%20the%20relief%20of%20a%2014-year-old%20girl%20brunette%20teen%20girl%20seated%20at%20a%20picnic.%22?model=flux&seed=403264547&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20closeup%20of%20a%20coin%20featuring%20the%20relief%20of%20a%20wheat%20field%22?model=flux&seed=447521017&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
{
    name: "Boy Coin",
    front: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20closeup%20of%20a%20coin%20featuring%20the%20face%20and%20shoulders%20of%20a%2014-year-old%20boy%20brunette%20teen%20boy%22?model=flux&seed=647377990&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false",
    back: "https://enter.pollinations.ai/api/generate/image/%22Imagine%20a%20closeup%20of%20a%20coin%20featuring%20the%20relief%20of%20a%20fishing%20pole%20leaning%20on%20a%20log%20by%20a%20lake%22?model=flux&seed=480966644&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false"
},
        {
            name: "Santa Claus",
            front: "https://enter.pollinations.ai/api/generate/image/Closeup%20of%20Santa%20Claus's%20face?model=zimage&seed=561617747&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/Flip%20the%20view%20to%20see%20him%20from%20the%20back%20of%20his%20head%20in%20the%20same%20position%20and%20posture%2C%20make%20sure%20the%20top%20of%20the%20hat%20still%20falls%20on%20the%20right%20shoulder?model=seedream-pro&seed=159230471&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false&image=https%3A%2F%2Fenter.pollinations.ai%2Fapi%2Fgenerate%2Fimage%2FCloseup%2520of%2520Santa%2520Claus%27s%2520face%3Fmodel%3Dzimage%26seed%3D561617747%26private%3Dtrue%26nologo%3Dtrue%26enhance%3Dtrue%26safe%3Dtrue%26nofeed%3Dtrue%26guidance_scale%3D7%26width%3D1024%26height%3D1024%26quality%3Dhd%26transparent%3Dfalse"
        },
        {
            name: "Chicken",
            front: "https://enter.pollinations.ai/api/generate/image/Closeup%20of%20a%20chicken%20staring%20straight%20ahead?model=zimage&seed=638554716&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/turn%20the%20chicken%20around%20for%20a%20view%20from%20the%20back%20at%20the%20same%20height.%20Be%20sure%20it%20is%20a%20perfect%20180%20degree%20view%20from%20the%20back%20behind%20its%20tail.?model=nanobanana-pro&seed=634314711&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1920&height=1920&quality=hd&transparent=false&image=https%3A%2F%2Fenter.pollinations.ai%2Fapi%2Fgenerate%2Fimage%2FCloseup%2520of%2520a%2520chicken%2520staring%2520straight%2520ahead%3Fmodel%3Dzimage%26seed%3D638554716%26private%3Dtrue%26nologo%3Dtrue%26enhance%3Dtrue%26safe%3Dtrue%26nofeed%3Dtrue%26guidance_scale%3D7%26width%3D1024%26height%3D1024%26quality%3Dhd%26transparent%3Dfalse"
        },
        {
            name: "Zebra",
            front: "https://enter.pollinations.ai/api/generate/image/A%20zebra%20looking%20straight%20at%20the%20camera?model=zimage&seed=610049763&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/the%20camera%20looking%20directly%20at%20the%20butt%20of%20a%20zebra?model=zimage&seed=478641423&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        },
        {
            name: "Elephant",
            front: "https://enter.pollinations.ai/api/generate/image/the%20camera%20looking%20directly%20at%20the%20rear%20of%20an%20elephant?model=zimage&seed=478641423&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/the%20camera%20looking%20directly%20at%20the%20tail%20of%20an%20elephant?model=zimage&seed=478641423&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        },
        {
            name: "Bull",
            front: "https://enter.pollinations.ai/api/generate/image/a%20brown%20bull%20with%20white%20horns%20directly%20facing%20the%20camera?model=zimage&seed=734579346&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/the%20camera%20looking%20directly%20at%20the%20tail%20and%20rear%20of%20a%20bull%20facing%20away%20from%20the%20camera?model=zimage&seed=734579346&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        },
        {
            name: "Girl",
            front: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20a%2014-year-old%20Scandinavian%20teen%20girl%20looking%20directly%20at%20the%20camera%2C%20wearing%20a%20purple%20scarf%20around%20her%20neck?model=flux&seed=679119800&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20the%20back%20of%20the%20head%20of%20a%2014-year-old%20Scandinavian%20teen%20girl%20wearing%20a%20purple%20scarf%20around%20her%20neck?model=flux&seed=565108732&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        },
        {
            name: "Boy",
            front: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20a%2014-year-old%20Hispanic%20teen%20boy%20looking%20directly%20at%20the%20camera%2C%20wearing%20a%20purple%20scarf%20around%20her%20neck?model=flux&seed=570629320&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20the%20back%20of%20the%20head%20of%20a%2014-year-old%20Hispanic%20teen%20boy%20wearing%20a%20purple%20scarf%20around%20her%20neck?model=flux&seed=565108732&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        },
        {
            name: "Rubber Duck",
            front: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20a%20yellow%20rubber%20duck%20directly%20facing%20the%20camera?model=flux&seed=565108732&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false",
            back: "https://enter.pollinations.ai/api/generate/image/a%20closeup%20of%20a%20yellow%20rubber%20duck%20directly%20facing%20away%20from%20the%20camera?model=flux&seed=427232980&private=true&nologo=true&enhance=true&safe=false&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=hd&transparent=false"
        }
    ];

    /** 1. THREE.JS SCENE SETUP **/
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    const camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    camera.position.set(0, 8, 12);
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const mainLight = new THREE.SpotLight(0xffffff, 0.4);
    mainLight.position.set(5, 12, 5);
    mainLight.castShadow = true;
    scene.add(mainLight);

    /** 2. FLOOR & ENVIRONMENT (TEXTURED) **/
    function getTableMaterial(surface) {
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');

        if (surface === 'standard') {
            return new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8 });
        }
        
        switch(surface) {
            case 'red-felt': createFeltTexture(ctx, '#3D0000', '#4A0000', '#2F0000'); break;
            case 'blue-felt': createFeltTexture(ctx, '#1A3A5C', '#2A4A6C', '#0A2A4C'); break;
            case 'purple-felt': createFeltTexture(ctx, '#2D1A3D', '#3D2A4D', '#1D0A2D'); break;
            case 'green-felt': createFeltTexture(ctx, '#064420', '#075428', '#053618'); break;
            case 'wood': createWoodTexture(ctx); break;
            case 'steel': createMetalTexture(ctx); break;
            case 'dirt': createDirtTexture(ctx); break;
        }

        const previewCanvas = document.getElementById('surfacePreviewCanvas');
        const pCtx = previewCanvas.getContext('2d');
        pCtx.clearRect(0,0, previewCanvas.width, previewCanvas.height);
        pCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
        
        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(20, 20); 
        
        return new THREE.MeshStandardMaterial({ 
            map: texture, 
            roughness: surface.includes('felt') ? 0.95 : (surface === 'wood' ? 0.6 : (surface === 'dirt' ? 0.98 : 0.3)),
            metalness: surface === 'steel' ? 0.8 : 0
        });
    }

    function createFeltTexture(ctx, baseColor, lightColor, darkColor) {
        ctx.fillStyle = baseColor;
        ctx.fillRect(0, 0, 512, 512);
        for(let i = 0; i < 50000; i++) {
            const x = Math.random() * 512;
            const y = Math.random() * 512;
            const brightness = Math.random();
            ctx.fillStyle = brightness > 0.5 ? lightColor : darkColor;
            ctx.globalAlpha = 0.12;
            ctx.fillRect(x, y, Math.random() * 2, Math.random() * 2);
        }
        ctx.globalAlpha = 1;
    }

    function createWoodTexture(ctx) {
        const gradient = ctx.createLinearGradient(0, 0, 512, 512);
        gradient.addColorStop(0, '#7A3E1A'); gradient.addColorStop(0.5, '#8B4513'); gradient.addColorStop(1, '#7A3E1A');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 512, 512);
        for(let ring = 0; ring < 15; ring++) {
            const baseY = ring * 40 + Math.random() * 30;
            ctx.strokeStyle = `rgba(100, 60, 30, 0.3)`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let x = 0; x < 512; x += 2) {
                ctx.lineTo(x, baseY + Math.sin(x * 0.02) * 10);
            }
            ctx.stroke();
        }
    }

    function createMetalTexture(ctx) {
        const gradient = ctx.createLinearGradient(0, 0, 512, 512);
        gradient.addColorStop(0, '#8A95A5'); gradient.addColorStop(0.5, '#B8C5D6'); gradient.addColorStop(1, '#8A95A5');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 512, 512);
        ctx.globalAlpha = 0.12;
        for(let i = 0; i < 1000; i++) {
            ctx.strokeStyle = '#fff'; ctx.beginPath();
            const x = Math.random() * 512; const y = Math.random() * 512;
            ctx.moveTo(x, y); ctx.lineTo(x + 100, y + 10); ctx.stroke();
        }
        ctx.globalAlpha = 1;
    }

    function createDirtTexture(ctx) {
        ctx.fillStyle = '#5C3A1F';
        ctx.fillRect(0, 0, 512, 512);
        for(let i = 0; i < 5000; i++) {
            const x = Math.random() * 512; const y = Math.random() * 512;
            const shade = 40 + Math.random() * 40;
            ctx.fillStyle = `rgb(${shade+20}, ${shade}, ${shade-10})`;
            ctx.fillRect(x, y, 2, 2);
        }
    }

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), getTableMaterial('wood'));
    floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; scene.add(floor);

    /** 3. THE COIN CREATION **/
    const COIN_RADIUS = 1.5; const COIN_THICK = 0.28; const loader = new THREE.TextureLoader();
    let currentHeadTex = loader.load(COIN_PRESETS[1].front);
    let currentTailTex = loader.load(COIN_PRESETS[1].back);
    let coins = [];

    function createCoin() {
        const group = new THREE.Group();
        const bodyMats = [new THREE.MeshStandardMaterial({ color: 0x95a5a6, metalness: 0.8 }), new THREE.MeshStandardMaterial({ map: currentHeadTex }), new THREE.MeshStandardMaterial({ map: currentTailTex })];
        const coinBody = new THREE.Mesh(new THREE.CylinderGeometry(COIN_RADIUS, COIN_RADIUS, COIN_THICK, 72), bodyMats);
        coinBody.castShadow = true; group.add(coinBody);
        const lipMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 1.0, roughness: 0.1 });
        const torusGeom = new THREE.TorusGeometry(COIN_RADIUS - 0.01, 0.06, 16, 100);
        const topLip = new THREE.Mesh(torusGeom, lipMat); topLip.rotation.x = Math.PI/2; topLip.position.y = COIN_THICK/2;
        const bottomLip = new THREE.Mesh(torusGeom, lipMat); bottomLip.rotation.x = Math.PI/2; bottomLip.position.y = -COIN_THICK/2;
        group.add(topLip, bottomLip); group.position.y = COIN_THICK/2; scene.add(group);
        return { group, bodyMats };
    }

    function updateCoinCount() {
        const coinCount = Math.min(Math.max(parseInt(document.getElementById('coinCountInput').value) || 1, 1), 25);
        while (coins.length < coinCount) coins.push(createCoin());
        while (coins.length > coinCount) { const c = coins.pop(); scene.remove(c.group); }
        coins.forEach((coin, idx) => {
            const row = Math.floor(idx / 5); const col = idx % 5;
            const numRows = Math.ceil(coins.length / 5); const itemsInThisRow = (row === numRows - 1) ? (coins.length % 5 || 5) : 5;
            const xOffset = (col - (itemsInThisRow - 1) / 2) * (COIN_RADIUS * 2.5);
            const zOffset = (row - (numRows - 1) / 2) * (COIN_RADIUS * 2.5);
            coin.group.position.set(xOffset, COIN_THICK / 2, zOffset); coin.group.rotation.set(0, 0, 0);
        });
    }
    updateCoinCount();

    /** 4. LOGIC & ANIMATION **/
    let roundNum = 1; let isFlipping = false; let stopRequested = false;
    function addRow() {
        const tr = document.createElement('tr'); tr.id = 'r-' + roundNum;
        tr.innerHTML = `<td>${roundNum}</td><td><span class="h-val">0</span><span class="h-pct pct">0.0%</span></td><td><span class="t-val">0</span><span class="t-pct pct">0.0%</span></td><td class="rt">0</td>`;
        document.getElementById('tableBody').appendChild(tr);
    }
    addRow();

    async function handleFlipSequence() {
        if (isFlipping) return;
        const count = Math.max(parseInt(document.getElementById('flipCount').value) || 1, 1);
        isFlipping = true; stopRequested = false; document.getElementById('flipBtn').disabled = true;
        for (let i = 0; i < count; i++) {
            if (stopRequested) break;
            const results = []; const animations = [];
            coins.forEach((coin, idx) => {
                const res = Math.random() < 0.5 ? 'heads' : 'tails'; results.push(res);
                const row = Math.floor(idx / 5); const col = idx % 5;
                const numRows = Math.ceil(coins.length / 5); const itemsInThisRow = (row === numRows - 1) ? (coins.length % 5 || 5) : 5;
                const xOffset = (col - (itemsInThisRow - 1) / 2) * (COIN_RADIUS * 2.5);
                const zOffset = (row - (numRows - 1) / 2) * (COIN_RADIUS * 2.5);
                animations.push(animateCoin(coin.group, res, xOffset, zOffset));
            });
            await Promise.all(animations); results.forEach(res => updateTable(res));
        }
        isFlipping = false; document.getElementById('flipBtn').disabled = false;
    }

    function animateCoin(coinGrp, result, xPos, zPos) {
        return new Promise(resolve => {
            const jumpHeight = 5.2 + (Math.random() * 2); 
            const minTumbles = 6; const extraTumbles = Math.floor(Math.random() * 4);
            const finalX = (result === 'heads') ? (Math.PI * (minTumbles + extraTumbles) * 2) : (Math.PI * ((minTumbles + extraTumbles) * 2 + 1));
            const finalY = coinGrp.rotation.y + (Math.PI * 1.5) + (Math.random() * Math.PI * 3);
            const finalZ = (Math.random() - 0.5) * 1.1; 
            const tl = gsap.timeline({ onComplete: resolve });
            coinGrp.rotation.x %= (Math.PI * 2);
            tl.to(coinGrp.position, { x: xPos, z: zPos, y: jumpHeight, duration: 0.6, ease: "power2.out" });
            tl.to(coinGrp.rotation, { x: finalX, y: finalY, z: finalZ, duration: 1.1, ease: "none" }, 0);
            tl.to(coinGrp.position, { y: COIN_THICK/2, duration: 0.5, ease: "bounce.out" }, "-=0.2");
            tl.to(coinGrp.rotation, { x: finalX, z: 0, duration: 0.3 }, "-=0.4");
        });
    }

    function updateTable(result) {
        const row = document.getElementById('r-' + roundNum);
        const hVal = row.querySelector('.h-val'); const tVal = row.querySelector('.t-val');
        if (result === 'heads') hVal.innerText = parseInt(hVal.innerText) + 1; else tVal.innerText = parseInt(tVal.innerText) + 1;
        const rh = parseInt(hVal.innerText); const rt = parseInt(tVal.innerText); const rTotal = rh + rt;
        row.querySelector('.rt').innerText = rTotal; row.querySelector('.h-pct').innerText = ((rh / rTotal) * 100).toFixed(1) + "%"; row.querySelector('.t-pct').innerText = ((rt / rTotal) * 100).toFixed(1) + "%";
        let gh = 0, gt = 0;
        document.querySelectorAll('.h-val').forEach(c => gh += parseInt(c.innerText));
        document.querySelectorAll('.t-val').forEach(c => gt += parseInt(c.innerText));
        const grandTotal = gh + gt;
        document.getElementById('gh').innerText = gh; document.getElementById('gt').innerText = gt; document.getElementById('gall').innerText = grandTotal;
        if (grandTotal > 0) { document.getElementById('ghp').innerText = ((gh / grandTotal) * 100).toFixed(1) + "%"; document.getElementById('gtp').innerText = ((gt / grandTotal) * 100).toFixed(1) + "%"; }
    }

    /** 5. SETTINGS UI LOGIC **/
    const menu = document.getElementById('settingsMenu');
    document.getElementById('settingsBtn').onclick = () => menu.style.display = 'block';
    document.getElementById('closeSettings').onclick = () => menu.style.display = 'none';
    document.getElementById('tableSurfaceSelect').onchange = (e) => { floor.material.dispose(); floor.material = getTableMaterial(e.target.value); };

    function updateCoin(headSrc, tailSrc) {
        currentHeadTex = loader.load(headSrc); currentTailTex = loader.load(tailSrc);
        coins.forEach(c => { c.bodyMats[1].map = currentHeadTex; c.bodyMats[1].needsUpdate = true; c.bodyMats[2].map = currentTailTex; c.bodyMats[2].needsUpdate = true; });
        menu.style.display = 'none';
    }

    const coll = document.getElementsByClassName("collapsible");
    for (let i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() { this.classList.toggle("active"); const content = this.nextElementSibling; content.style.display = (content.style.display === "block") ? "none" : "block"; });
    }

    /** AI GENERATION LOGIC **/
    const AI_API_KEY = "plln_pk_EkZu7wQbWUw3wgymmnYCE2H82ipNioP5LePrDPZbUVqoyQA4uXWcbIva7vqtxPhL";

    async function handleAIGenerate(side) {
        const promptInput = document.getElementById(side === 'heads' ? 'aiHeadsPrompt' : 'aiTailsPrompt');
        const urlField = document.getElementById(side === 'heads' ? 'headsUrlInput' : 'tailsUrlInput');
        const previewImg = document.getElementById(side === 'heads' ? 'headsPreview' : 'tailsPreview');
        const imgSpinner = document.getElementById(side === 'heads' ? 'spinImgHeads' : 'spinImgTails');
        const promptText = promptInput.value.trim();
        if (!promptText) { alert("Please enter a prompt first."); return; }

        imgSpinner.style.visibility = 'visible';
        const seed = Math.floor(Math.random() * 999999999);
        const baseUrl = `https://enter.pollinations.ai/api/generate/image/${encodeURIComponent(promptText)}?model=flux&seed=${seed}&private=true&nologo=true&enhance=true&safe=true&nofeed=true&guidance_scale=7&width=1024&height=1024&quality=high&transparent=false`;
        const fullUrl = `${baseUrl}&key=${AI_API_KEY}`;

        const imgLoader = new Image();
        imgLoader.onload = () => {
            previewImg.src = fullUrl;
            imgSpinner.style.visibility = 'hidden';
            setTimeout(() => { urlField.value = baseUrl; }, 1000);
        };
        imgLoader.onerror = () => { imgSpinner.style.visibility = 'hidden'; previewImg.src = fullUrl; setTimeout(() => { urlField.value = baseUrl; }, 1000); };
        imgLoader.src = fullUrl;
    }

    async function handleAIRandomizer(side) {
        const promptInput = document.getElementById(side === 'heads' ? 'aiHeadsPrompt' : 'aiTailsPrompt');
        const textSpinner = document.getElementById(side === 'heads' ? 'spinTextHeads' : 'spinTextTails');
        textSpinner.style.visibility = 'visible';
        const seed = Math.floor(Math.random() * 1000000);
        const textUrl = `https://gen.pollinations.ai/text/${encodeURIComponent("Give me a random short sentence describing a unique art style for a circular coin relief.")}?model=nova-micro&seed=${seed}&key=${AI_API_KEY}`;
        try {
            const response = await fetch(textUrl); const text = await response.text();
            promptInput.value = text.trim(); textSpinner.style.visibility = 'hidden';
            setTimeout(() => { handleAIGenerate(side); }, 200);
        } catch (e) { textSpinner.style.visibility = 'hidden'; console.error("Text Gen failed", e); }
    }

    document.getElementById('genHeadsBtn').onclick = () => handleAIGenerate('heads');
    document.getElementById('regenHeadsBtn').onclick = () => handleAIGenerate('heads');
    document.getElementById('randHeadsBtn').onclick = () => handleAIRandomizer('heads');
    document.getElementById('genTailsBtn').onclick = () => handleAIGenerate('tails');
    document.getElementById('regenTailsBtn').onclick = () => handleAIGenerate('tails');
    document.getElementById('randTailsBtn').onclick = () => handleAIRandomizer('tails');

    const hPreview = document.getElementById('headsPreview'); const tPreview = document.getElementById('tailsPreview');
    document.getElementById('headsUrlInput').oninput = (e) => hPreview.src = e.target.value;
    document.getElementById('tailsUrlInput').oninput = (e) => tPreview.src = e.target.value;
    document.getElementById('headsFile').onchange = async (e) => { if (e.target.files[0]) hPreview.src = await toBase64(e.target.files[0]); };
    document.getElementById('tailsFile').onchange = async (e) => { if (e.target.files[0]) tPreview.src = await toBase64(e.target.files[0]); };

    document.getElementById('clearCustomFields').onclick = () => {
        document.getElementById('headsUrlInput').value = ''; document.getElementById('tailsUrlInput').value = '';
        document.getElementById('headsFile').value = ''; document.getElementById('tailsFile').value = '';
        document.getElementById('aiHeadsPrompt').value = ''; document.getElementById('aiTailsPrompt').value = '';
        hPreview.src = ''; tPreview.src = '';
    };

    const presetContainer = document.getElementById('presetList');
    COIN_PRESETS.forEach(coin => {
        const item = document.createElement('div'); item.className = 'preset-item';
        item.innerHTML = `<div class="preset-imgs"><img src="${coin.front}"><img src="${coin.back}"></div><div class="preset-name">${coin.name}</div>`;
        item.onclick = () => updateCoin(coin.front, coin.back); presetContainer.appendChild(item);
    });

    document.getElementById('applyCustom').onclick = async () => {
        const hUrl = document.getElementById('headsUrlInput').value; const tUrl = document.getElementById('tailsUrlInput').value;
        const hFile = document.getElementById('headsFile').files[0]; const tFile = document.getElementById('tailsFile').files[0];
        let finalH = hUrl; let finalT = tUrl;
        if (hFile) finalH = await toBase64(hFile); if (tFile) finalT = await toBase64(tFile);
        if (finalH && finalT) updateCoin(finalH, finalT); else alert("Please provide both Heads and Tails (via URL or Upload)");
    };

    const toBase64 = file => new Promise((res, rej) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => res(reader.result); reader.onerror = e => rej(e); });

    /** 6. UI EVENTS **/
    document.getElementById('coinCountInput').oninput = updateCoinCount;
    document.getElementById('flipBtn').onclick = handleFlipSequence;
    document.getElementById('stopBtn').onclick = () => { if (isFlipping) stopRequested = true; };
    document.getElementById('nextRoundBtn').onclick = () => { if(!isFlipping){ roundNum++; addRow(); }};
    document.getElementById('resetBtn').onclick = () => {
        if(isFlipping) return; document.getElementById('tableBody').innerHTML = ''; roundNum = 1; addRow();
        document.getElementById('gh').innerText = '0'; document.getElementById('gt').innerText = '0'; document.getElementById('gall').innerText = '0';
        document.getElementById('ghp').innerText = '0.0%'; document.getElementById('gtp').innerText = '0.0%';
        coins.forEach((c, idx) => {
            const row = Math.floor(idx / 5); const col = idx % 5;
            const numRows = Math.ceil(coins.length / 5); const itemsInThisRow = (row === numRows - 1) ? (coins.length % 5 || 5) : 5;
            const xOffset = (col - (itemsInThisRow - 1) / 2) * (COIN_RADIUS * 2.5); const zOffset = (row - (numRows - 1) / 2) * (COIN_RADIUS * 2.5);
            gsap.to(c.group.position, { x: xOffset, y: COIN_THICK / 2, z: zOffset, duration: 0.5 }); gsap.to(c.group.rotation, { x: 0, y: 0, z: 0, duration: 0.5 });
        });
    };

    window.addEventListener('resize', () => { camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();
</script>
</body>
</html>
