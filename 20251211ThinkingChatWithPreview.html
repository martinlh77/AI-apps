<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollinations AI Chat (Audio Enabled)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f4f4f9;
            --chat-bg: #ffffff;
            --text-color: #333333;
            --input-bg: #ffffff;
            --border-color: #ddd;
            --user-msg-bg: #007bff;
            --user-msg-text: #ffffff;
            --ai-msg-bg: #e9ecef;
            --ai-msg-text: #333333;
            --code-header-bg: #2d2d2d;
            --scrollbar-thumb: #ccc;
            --reset-btn-bg: #dc3545;
            --reset-btn-hover: #c82333;
            --full-reset-btn-bg: #6c757d;
            --full-reset-btn-hover: #5a6268;
            --session-panel-bg: #f8f9fa;
            --session-active: #007bff;
            --session-hover: #e9ecef;
            --preview-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --chat-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --input-bg: #2c2c2c;
            --border-color: #444;
            --user-msg-bg: #0056b3;
            --ai-msg-bg: #333333;
            --ai-msg-text: #e0e0e0;
            --scrollbar-thumb: #555;
            --reset-btn-bg: #dc3545;
            --reset-btn-hover: #c82333;
            --full-reset-btn-bg: #6c757d;
            --full-reset-btn-hover: #5a6268;
            --session-panel-bg: #2d2d2d;
            --session-active: #007bff;
            --session-hover: #444;
            --preview-bg: #1e1e1e;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s; }

        /* Header */
        header { padding: 10px 20px; background-color: var(--chat-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .settings-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); }
        .session-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); margin-right: 10px; }
        
        /* Main Chat Area */
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        /* Messages */
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .message-wrapper.user { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.ai { align-self: flex-start; align-items: flex-start; }
        
        .message-sender { font-size: 0.75rem; margin-bottom: 4px; opacity: 0.7; display: flex; align-items: center; gap: 5px; }
        .copy-msg-btn { cursor: pointer; font-size: 0.8rem; opacity: 0.5; transition: opacity 0.2s; }
        .copy-msg-btn:hover { opacity: 1; }

        .message-bubble { padding: 12px 16px; border-radius: 12px; line-height: 1.5; position: relative; word-wrap: break-word; overflow-x: auto; }
        .user .message-bubble { background-color: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: 2px; }
        .ai .message-bubble { background-color: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: 2px; width: 100%; }

        /* Images in chat */
        .chat-image { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color); }

        /* Code Blocks */
        .code-container { margin: 10px 0; border-radius: 6px; overflow: hidden; border: 1px solid #444; background: #1e1e1e; }
        .code-header { background: var(--code-header-bg); color: #ccc; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; font-family: monospace; }
        .code-header-buttons { display: flex; gap: 5px; }
        .copy-code-btn, .preview-code-btn { background: #444; color: #fff; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; }
        .copy-code-btn:hover, .preview-code-btn:hover { background: #555; }
        .preview-code-btn { background: #28a745; }
        .preview-code-btn:hover { background: #218838; }
        pre { margin: 0; padding: 10px; overflow-x: auto; }
        code { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; }

        /* Preview Panel */
        #preview-panel { 
            position: fixed; 
            top: 0; 
            right: -50%; 
            width: 50%; 
            height: 100%; 
            background-color: var(--preview-bg); 
            border-left: 2px solid var(--border-color); 
            transition: right 0.3s ease-in-out; 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        #preview-panel.open { right: 0; }
        
        .preview-header { 
            padding: 15px 20px; 
            background-color: var(--chat-bg); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .preview-header h3 { margin: 0; font-size: 1rem; }
        .close-preview { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: var(--text-color); 
        }
        
        #preview-iframe { 
            flex: 1; 
            border: none; 
            background: white; 
            width: 100%;
        }
        
        .preview-controls {
            padding: 10px 20px;
            background-color: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        .preview-control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--user-msg-bg);
            color: white;
            font-size: 0.85rem;
        }
        .preview-control-btn:hover {
            opacity: 0.9;
        }

        /* Input Area */
        .input-area { background-color: var(--chat-bg); padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; align-items: flex-end; }
        .file-upload-label { cursor: pointer; padding: 10px; color: var(--text-color); }
        textarea { flex: 1; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; resize: none; min-height: 44px; max-height: 150px; font-family: inherit; }
        textarea:focus { outline: none; border-color: var(--user-msg-bg); }
        .send-btn { background-color: var(--user-msg-bg); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; height: 44px; font-weight: bold; }
        .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .stop-btn { background-color: var(--reset-btn-bg); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; height: 44px; font-weight: bold; display: none; }
        .stop-btn:hover { background-color: var(--reset-btn-hover); }
        
        /* Reset Buttons */
        .reset-buttons { display: flex; gap: 10px; padding: 10px 15px; background-color: var(--chat-bg); border-top: 1px solid var(--border-color); }
        .reset-btn { 
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .reset-btn.reset-chat { 
            background-color: var(--reset-btn-bg); 
            color: white; 
        }
        .reset-btn.reset-chat:hover { 
            background-color: var(--reset-btn-hover); 
        }
        .reset-btn.full-reset { 
            background-color: var(--full-reset-btn-bg); 
            color: white; 
        }
        .reset-btn.full-reset:hover { 
            background-color: var(--full-reset-btn-hover); 
        }

        /* Session Panel */
        #session-panel { 
            position: fixed; 
            top: 0; 
            left: -320px; 
            width: 300px; 
            height: 100%; 
            background-color: var(--session-panel-bg); 
            border-right: 1px solid var(--border-color); 
            transition: left 0.3s; 
            z-index: 1000; 
            padding: 20px; 
            overflow-y: auto; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
        }
        #session-panel.open { left: 0; }
        .session-panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .close-session-panel { 
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            cursor: pointer; 
            color: var(--text-color); 
        }
        .session-list { 
            margin-top: 10px; 
        }
        .session-item { 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            background-color: var(--chat-bg); 
            border: 1px solid var(--border-color); 
            transition: all 0.2s; 
        }
        .session-item:hover { 
            background-color: var(--session-hover); 
        }
        .session-item.active { 
            background-color: var(--session-active); 
            color: white; 
        }
        .session-title { 
            font-weight: bold; 
            margin-bottom: 5px; 
            word-break: break-word; 
        }
        .session-meta { 
            font-size: 0.8rem; 
            opacity: 0.8; 
        }
        .session-actions { 
            display: flex; 
            gap: 5px; 
            margin-top: 8px; 
        }
        .session-action-btn { 
            background: none; 
            border: none; 
            color: var(--text-color); 
            cursor: pointer; 
            font-size: 0.9rem; 
        }
        .session-action-btn.delete { 
            color: #dc3545; 
        }

        /* Settings Panel */
        #settings-panel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background-color: var(--chat-bg); border-left: 1px solid var(--border-color); transition: right 0.3s; z-index: 1000; padding: 20px; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        #settings-panel.open { right: 0; }
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .settings-group select, .settings-group input { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); }
        .close-settings { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.2rem; }

        /* Audio Controls */

        /* Audio Controls */
        .audio-controls { 
            margin-top: 10px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            background: rgba(0,0,0,0.05); 
            padding: 8px; 
            border-radius: 5px; 
        }
        .audio-btn { 
            background: var(--user-msg-bg); 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.8rem; 
        }
        .audio-btn:hover {
            opacity: 0.9;
        }
        /* Preview Area for Uploads */
        #file-preview { display: flex; gap: 10px; flex-wrap: wrap; padding: 0 15px; background: var(--chat-bg); }
        .preview-item { font-size: 0.8rem; background: var(--ai-msg-bg); padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; }
        .remove-file { cursor: pointer; color: red; font-weight: bold; }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: translateX(200%);
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        .notification.show {
            transform: translateX(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #preview-panel { width: 100%; right: -100%; }
            .message-wrapper { max-width: 95%; }
        }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center;">
            <button class="session-btn" id="toggle-sessions"><i class="fas fa-folder"></i></button>
            <div style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-robot"></i> Pollinations Chat</div>
        </div>
        <button class="settings-btn" id="toggle-settings"><i class="fas fa-cog"></i></button>
    </header>

    <div id="session-panel">
        <div class="session-panel-header">
            <h3>Saved Sessions</h3>
            <button class="close-session-panel" id="close-sessions">&times;</button>
        </div>
        <div id="session-list" class="session-list"></div>
        <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--border-color);">
            <button id="new-session-btn" class="reset-btn reset-chat" style="width: 100%;">
                <i class="fas fa-plus"></i> New Session
            </button>
        </div>
    </div>

    <div id="chat-container">
        <div class="message-wrapper ai">
            <div class="message-sender">System</div>
            <div class="message-bubble">Hello! I am ready to chat. Ensure your Token is set in the settings.</div>
        </div>
    </div>

    <div id="file-preview"></div>

    <div class="input-area">
        <label for="file-input" class="file-upload-label" title="Upload Text, Image, Audio, HTML, JSON">
            <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-input" multiple style="display: none;" accept="image/*,audio/*,text/*,.json,.html,.js,.css,.py">
        
        <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
        <button id="send-btn" class="send-btn" type="button"><i class="fas fa-paper-plane"></i></button>
        <button id="stop-btn" class="stop-btn" type="button" title="Stop Generation"><i class="fas fa-stop"></i></button>
    </div>

    <div class="reset-buttons">
        <button id="reset-chat-btn" class="reset-btn reset-chat" type="button"><i class="fas fa-trash-alt"></i> Reset Chat</button>
        <button id="full-reset-btn" class="reset-btn full-reset" type="button"><i class="fas fa-redo"></i> Full Reset</button>
    </div>

    <!-- Preview Panel -->
    <div id="preview-panel">
        <div class="preview-header">
            <h3><i class="fas fa-eye"></i> Live Preview</h3>
            <button class="close-preview" id="close-preview">&times;</button>
        </div>
        <iframe id="preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        <div class="preview-controls">
            <button class="preview-control-btn" id="refresh-preview"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="preview-control-btn" id="open-new-tab"><i class="fas fa-external-link-alt"></i> Open in New Tab</button>
        </div>
    </div>

    <div id="settings-panel">
        <div class="close-settings" id="close-settings">&times;</div>
        <h3>Settings</h3>
        
        <div class="settings-group">
            <label>Theme</label>
            <button id="theme-toggle" type="button" style="width:100%; padding:8px; cursor:pointer;">Switch to Dark Mode</button>
        </div>

        <div class="settings-group">
            <label>Token Key</label>
            <input type="password" id="api-token" placeholder="Enter Bearer Token">
        </div>

<!-- System Message -->
    <div class="settings-group">
        <label>System Message</label>
        <textarea id="system-message" placeholder="You are a helpful AI assistant" rows="3" style="resize: vertical; min-height: 60px;"></textarea>
        <small style="color:var(--text-color); opacity:0.7;">Defines the AI's role and behavior.</small>
   </div>

        <div class="settings-group">
            <label>Voice Style/Emotion</label>
            <input type="text" id="voice-style" placeholder="e.g. Excited, Whispering, Angry" value="snarky">
            <small style="color:var(--text-color); opacity:0.7;">
                Applies to both voice tone and AI response style.
            </small>
        </div>

        <div class="settings-group">
            <label>Model</label>
            <select id="model-select">
                <option value="openai-audio">OpenAI Audio üó£Ô∏è (Best for Voice)</option>
                <option value="qwen-coder">Qwen 2.5 Coderüíª</option>
                <option value="gemini-search">Gemini-SearchüëÅÔ∏èüîç</option>
                <option value="gemini-large">Gemini-LargeüëÅÔ∏èüëÇüß†üíª</option>
                <option value="claude-large">Claude-LargeüëÅÔ∏èüíª</option>
                <option value="perplexity-reasoning">Perplexity-Reasoningüß†üîç</option>
                <option value="openai-large">Openai-LargeüëÅÔ∏èüíª</option>
                <option value="nova-micro">Nova-Micro</option>
                <option value="mistral">Mistral</option>
                <option value="gemini">GeminiüëÅÔ∏è</option>
                <option value="openai">OpenaiüëÅÔ∏è</option>
                <option value="openai-fast">Openai-FastüëÅÔ∏è</option>
                <option value="grok">Grok</option>
                <option value="perplexity-fast">Perplexity-Fastüîç</option>
                <option value="chickytutor">Chicky Tutor</option>
                <option value="claude-fast">Claude-FastüëÅÔ∏è</option>
                <option value="kimi-k2-thinking">Kimi-k2-Thinkingüß†</option>
                <option value="claude" selected>ClaudeüëÅÔ∏è</option>
                <option value="openai-reasoning">Openai-ReasoningüëÅÔ∏èüß†</option>
                <option value="deepseek">Deepseeküß†</option>
            </select>
        </div>

        <hr>
        <h4>Audio Settings</h4>
        
        <div class="settings-group">
    <label>Show Audio Button</label>
    <input type="checkbox" id="audio-enable"> 
    <span style="font-size:0.9rem;">(Shows button on AI responses)</span>
</div>

        <div class="settings-group">
            <label>
                <input type="checkbox" id="audio-read-exactly" checked> 
                Read Text Exactly As Written
            </label>
            <small style="color:var(--text-color); opacity:0.7;">
                When unchecked, openai-audio generates its own response.
            </small>
        </div>

        <div class="settings-group">
            <label>Voice</label>
            <select id="voice-select">
                <optgroup label="Standard Voices">
                    <option value="alloy" selected>Alloy (Neutral)</option>
                    <option value="echo">Echo (Deep Male)</option>
                    <option value="fable">Fable (British-ish)</option>
                    <option value="onyx">Onyx (Deep/Gravel)</option>
                    <option value="nova">Nova (Energetic Female)</option>
                    <option value="shimmer">Shimmer (Clear Female)</option>
                </optgroup>
                <optgroup label="Extended Voices">
                    <option value="coral">Coral</option>
                    <option value="verse">Verse</option>
                    <option value="ballad">Ballad</option>
                    <option value="ash">Ash</option>
                    <option value="sage">Sage</option>
                    <option value="amuch">Amuch</option>
                    <option value="dan">Dan</option>
                </optgroup>
            </select>
        </div>

       <div class="settings-group">
    <label>Audio Length Limit</label>
    <select id="audio-length-limit">
        <option value="500">Short (30-60 sec)</option>
        <option value="1000" selected>Medium (1-2 min)</option>
        <option value="2000">Long (3-5 min)</option>
        <option value="4000" disabled>Very Long (10-15 min)</option>
        <option value="999999" disabled>Unlimited</option>
    </select>
    <small style="color:var(--text-color); opacity:0.7;">
        Longer audio takes more time to generate.
    </small>
</div>

<div class="settings-group">
    <label>
        <input type="checkbox" id="audio-upload-catbox"> 
        Upload Audio to Catbox.moe
    </label>
    <small style="color:var(--text-color); opacity:0.7;">
        Uploads audio for permanent hosting. Uncheck for local playback only.
    </small>
</div>
    </div>

    <div id="notification" class="notification"></div>

<script>
    // --- Configuration ---
    const USER_API_TOKEN = "plln_pk_EkZu7wQbWUw3wgymmnYCE2H82ipNioP5LePrDPZbUVqoyQA4uXWcbIva7vqtxPhL";
    const API_URL = "https://gen.pollinations.ai/v1/chat/completions";
    
    // --- State ---
    let conversationHistory = [];
    let uploadedFiles = [];
    let isDarkMode = false;
    let isGenerating = false;
    let currentSessionId = null;
    let sessions = {};
    let currentPreviewCode = { html: '', css: '', js: '' };
    let abortController = null;

    // --- DOM Elements ---
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const stopBtn = document.getElementById('stop-btn');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsBtn = document.getElementById('toggle-settings');
    const closeSettings = document.getElementById('close-settings');
    const themeToggle = document.getElementById('theme-toggle');
    const tokenInput = document.getElementById('api-token');
    const resetChatBtn = document.getElementById('reset-chat-btn');
    const fullResetBtn = document.getElementById('full-reset-btn');
    const notification = document.getElementById('notification');
    const sessionPanel = document.getElementById('session-panel');
    const toggleSessions = document.getElementById('toggle-sessions');
    const closeSessions = document.getElementById('close-sessions');
    const sessionList = document.getElementById('session-list');
    const newSessionBtn = document.getElementById('new-session-btn');
    const previewPanel = document.getElementById('preview-panel');
    const closePreview = document.getElementById('close-preview');
    const previewIframe = document.getElementById('preview-iframe');
    const refreshPreview = document.getElementById('refresh-preview');
    const openNewTab = document.getElementById('open-new-tab');
    
// --- Initialization ---
if(USER_API_TOKEN) tokenInput.value = USER_API_TOKEN;
// loadAllDataFromStorage(); // <--- MOVED TO END

// --- Markdown Renderer Setup with Preview Button ---
const renderer = new marked.Renderer();
    
    renderer.code = function({ text, lang }) {
        const validLang = !!(lang && hljs.getLanguage(lang)) ? lang : 'plaintext';
        
        let highlighted = text || '';
        try {
            if (text) {
                highlighted = hljs.highlight(text, { language: validLang }).value;
            }
        } catch (e) {
            console.error("Highlight error:", e);
        }

        const escapedText = (text || '').replace(/`/g, '\\`').replace(/\$/g, '\\$');
        const codeId = 'code-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Check if this is web code that can be previewed
        const isPreviewable = ['html', 'css', 'javascript', 'js'].includes(validLang.toLowerCase());
        
        const previewBtn = isPreviewable ? 
            `<button class="preview-code-btn" onclick="previewCode('${codeId}', '${validLang}')"><i class="fas fa-eye"></i> Preview</button>` : '';

        return `
            <div class="code-container">
                <div class="code-header">
                    <span>${validLang}</span>
                    <div class="code-header-buttons">
                        ${previewBtn}
                        <button class="copy-code-btn" onclick="copyToClipboard(this, \`${encodeURIComponent(text || '')}\`)">Copy</button>
                    </div>
                </div>
                <pre><code id="${codeId}" class="hljs ${validLang}" data-lang="${validLang}">${highlighted}</code></pre>
            </div>`;
    };

    marked.use({ renderer });

    // --- Preview Functions ---
    window.previewCode = function(codeId, lang) {
        const codeElement = document.getElementById(codeId);
        if (!codeElement) return;
        
        const code = codeElement.textContent;
        
        // Find parent AI message to get all code blocks
        const messageWrapper = codeElement.closest('.message-wrapper.ai');
        if (messageWrapper) {
            extractAllCodeFromMessage(messageWrapper);
        } else {
            // Single code block preview
            if (lang.toLowerCase() === 'html') {
                currentPreviewCode.html = code;
            } else if (lang.toLowerCase() === 'css') {
                currentPreviewCode.css = code;
            } else if (lang.toLowerCase() === 'javascript' || lang.toLowerCase() === 'js') {
                currentPreviewCode.js = code;
            }
        }
        
        updatePreview();
        previewPanel.classList.add('open');
        showNotification('Preview opened!');
    };

    function extractAllCodeFromMessage(messageWrapper) {
        // Reset current preview code
        currentPreviewCode = { html: '', css: '', js: '' };
        
        // Find all code blocks in this message
        const codeBlocks = messageWrapper.querySelectorAll('code[data-lang]');
        
        codeBlocks.forEach(codeBlock => {
            const lang = codeBlock.getAttribute('data-lang').toLowerCase();
            const code = codeBlock.textContent;
            
            if (lang === 'html') {
                currentPreviewCode.html = code;
            } else if (lang === 'css') {
                currentPreviewCode.css = code;
            } else if (lang === 'javascript' || lang === 'js') {
                currentPreviewCode.js = code;
            }
        });
    }

    function updatePreview() {
        const htmlContent = currentPreviewCode.html || '<body></body>';
        const cssContent = currentPreviewCode.css ? `<style>${currentPreviewCode.css}</style>` : '';
        const jsContent = currentPreviewCode.js ? `<script>${currentPreviewCode.js}<\/script>` : '';
        
        // Inject CSS and JS into HTML
        let finalHTML = htmlContent;
        
        // Try to inject CSS in head if HTML has proper structure
        if (finalHTML.includes('</head>')) {
            finalHTML = finalHTML.replace('</head>', `${cssContent}</head>`);
        } else if (finalHTML.includes('<body>')) {
            finalHTML = finalHTML.replace('<body>', `<head>${cssContent}</head><body>`);
        } else {
            finalHTML = `<!DOCTYPE html><html><head>${cssContent}</head><body>${finalHTML}</body></html>`;
        }
        
        // Inject JS before closing body tag
        if (finalHTML.includes('</body>')) {
            finalHTML = finalHTML.replace('</body>', `${jsContent}</body>`);
        } else {
            finalHTML += jsContent;
        }
        
        // Write to iframe
        const iframe = previewIframe;
        iframe.srcdoc = finalHTML;
    }

    // Preview panel controls
    closePreview.addEventListener('click', function() {
        previewPanel.classList.remove('open');
    });

    refreshPreview.addEventListener('click', function() {
        updatePreview();
        showNotification('Preview refreshed!');
    });

    openNewTab.addEventListener('click', function() {
        const htmlContent = currentPreviewCode.html || '<body></body>';
        const cssContent = currentPreviewCode.css ? `<style>${currentPreviewCode.css}</style>` : '';
        const jsContent = currentPreviewCode.js ? `<script>${currentPreviewCode.js}<\/script>` : '';
        
        let finalHTML = htmlContent;
        
        if (finalHTML.includes('</head>')) {
            finalHTML = finalHTML.replace('</head>', `${cssContent}</head>`);
        } else if (finalHTML.includes('<body>')) {
            finalHTML = finalHTML.replace('<body>', `<head>${cssContent}</head><body>`);
        } else {
            finalHTML = `<!DOCTYPE html><html><head>${cssContent}</head><body>${finalHTML}</body></html>`;
        }
        
        if (finalHTML.includes('</body>')) {
            finalHTML = finalHTML.replace('</body>', `${jsContent}</body>`);
        } else {
            finalHTML += jsContent;
        }
        
        const blob = new Blob([finalHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        
        showNotification('Opened in new tab!');
    });

    // --- Helper Functions ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- Dynamic Voice Loading ---
    async function loadAvailableVoices() {
        try {
            const token = tokenInput.value || USER_API_TOKEN;
            const res = await fetch('https://gen.pollinations.ai/text/models', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const models = await res.json();
            
            const audioModel = models.find(m => m.name === 'openai-audio');
            
            if (audioModel && audioModel.voices) {
                const voiceSelect = document.getElementById('voice-select');
                
                const standardVoices = ['alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'];
                const extendedVoices = audioModel.voices.filter(v => !standardVoices.includes(v));
                
                let html = '<optgroup label="Standard Voices">';
                standardVoices.forEach(voice => {
                    const descriptions = {
                        'alloy': 'Neutral',
                        'echo': 'Deep Male',
                        'fable': 'British-ish',
                        'onyx': 'Deep/Gravel',
                        'nova': 'Energetic Female',
                        'shimmer': 'Clear Female'
                    };
                    html += `<option value="${voice}">${voice.charAt(0).toUpperCase() + voice.slice(1)} (${descriptions[voice]})</option>`;
                });
                html += '</optgroup>';
                
                if (extendedVoices.length > 0) {
                    html += `<optgroup label="Extended Voices (${extendedVoices.length})">`;
                    extendedVoices.forEach(voice => {
                        html += `<option value="${voice}">${voice.charAt(0).toUpperCase() + voice.slice(1)}</option>`;
                    });
                    html += '</optgroup>';
                }
                
                voiceSelect.innerHTML = html;
                console.log(`‚úÖ Loaded ${audioModel.voices.length} voices from API`);
            }
        } catch (e) {
            console.error('Failed to load voices from API:', e);
            console.log('Using hardcoded voice list as fallback');
        }
    }

    // --- Event Listeners ---
settingsBtn.addEventListener('click', function(e) {
    e.preventDefault();
    settingsPanel.classList.add('open');
});

closeSettings.addEventListener('click', function(e) {
    e.preventDefault();
    settingsPanel.classList.remove('open');
});
    
    themeToggle.addEventListener('click', function(e) {
        e.preventDefault();
        isDarkMode = !isDarkMode;
        document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
        themeToggle.innerText = isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode";
    });

    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = '44px';
    });

    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', function(e) {
        e.preventDefault();
        sendMessage();
    });

    stopBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (abortController) {
            abortController.abort();
            abortController = null;
            isGenerating = false;
            sendBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            // Also clean up any lingering spinner if stopped manually
            const spinners = document.querySelectorAll('.fa-spinner');
            spinners.forEach(s => {
                const bubble = s.closest('.message-bubble');
                if(bubble) bubble.innerHTML += '<br>[Stopped by user]';
            });
        }
    });

    fileInput.addEventListener('change', handleFileUpload);
    
   
    // Reset buttons
    resetChatBtn.addEventListener('click', function(e) {
        e.preventDefault();
        resetChat();
    });
    
    fullResetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fullReset();
    });
    
    // Session panel
    toggleSessions.addEventListener('click', function(e) {
        e.preventDefault();
        sessionPanel.classList.add('open');
    });
    
    closeSessions.addEventListener('click', function(e) {
        e.preventDefault();
        sessionPanel.classList.remove('open');
    });
    
    newSessionBtn.addEventListener('click', function(e) {
        e.preventDefault();
        createNewSession();
    });

    // --- File Upload Logic ---
    function handleFileUpload(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const content = evt.target.result;
                
                let fileType = 'text';
                if(file.type.startsWith('image')) fileType = 'image';
                else if(file.type.startsWith('audio')) fileType = 'audio';
                
                uploadedFiles.push({
                    name: file.name,
                    type: fileType,
                    content: content,
                    mime: file.type
                });
                renderFilePreviews();
            };
            
            if (file.type.startsWith('image') || file.type.startsWith('audio')) {
                reader.readAsDataURL(file);
            } else {
                reader.readAsText(file);
            }
        });
        fileInput.value = '';
    }

    function renderFilePreviews() {
        filePreview.innerHTML = '';
        uploadedFiles.forEach((file, index) => {
            const el = document.createElement('div');
            el.className = 'preview-item';
            el.innerHTML = `<span>${file.name}</span> <span class="remove-file" onclick="removeFile(${index})">&times;</span>`;
            filePreview.appendChild(el);
        });
    }

    window.removeFile = function(index) {
        uploadedFiles.splice(index, 1);
        renderFilePreviews();
    };

    window.copyToClipboard = function(btn, encodedCode) {
        const code = decodeURIComponent(encodedCode);
        navigator.clipboard.writeText(code).then(() => {
            const originalText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = originalText, 2000);
        });
    };

    window.copyMessage = function(btn, textId) {
        const el = document.getElementById(textId);
        if (el) {
            const text = el.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = "fas fa-check";
                    setTimeout(() => icon.className = "fas fa-copy", 2000);
                }
            });
        }
    };

// --- Audio Generation Function (from catbox logic) ---
async function generateAudioForMessage(msgId, textContent, messagesContext = null) {
    const audioBtn = document.getElementById(`audio-btn-${msgId}`);
    if (!audioBtn) return;
    
    const originalText = audioBtn.innerHTML;
    audioBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    const newSeed = Math.floor(Math.random() * 999999);
    
    try {
        const maxLength = parseInt(document.getElementById('audio-length-limit')?.value || '4000');
        const text = textContent.slice(0, maxLength);
        const voice = document.getElementById('voice-select').value;
        const tone = document.getElementById('voice-style').value;
        const readExactly = document.getElementById('audio-read-exactly').checked; // New toggle
        
        let tts_prompt;
        if (readExactly) {
            // Read exactly what's in the message bubble
            tts_prompt = `${tone ? `(in a ${tone} tone) ` : ""}Read the following text exactly as written, word for word: "${text}"`;
        } else {
            // Let OpenAI audio model generate its own response
            tts_prompt = text; // Just pass the text directly
        }
        
        const token = tokenInput.value || USER_API_TOKEN;
        const apiLink = `https://gen.pollinations.ai/text/${encodeURIComponent(tts_prompt)}?model=openai-audio&seed=${newSeed}&voice=${voice}&stream=false&private=false`;
        const fetchUrl = `${apiLink}&key=${token}`;
        
        const res = await fetch(fetchUrl);
        
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Audio generation failed: ${res.status} ${res.statusText}. ${errorText}`);
        }
        
        const audioBlob = await res.blob();
        
        if (audioBlob.size === 0) throw new Error("Empty audio file received");
        
        const localBlobUrl = URL.createObjectURL(audioBlob);
        
        const container = document.getElementById(`audio-container-${msgId}`);
        if (!container) return;
        
        const previousAudio = container.querySelector('audio');
        if (previousAudio) previousAudio.parentElement.remove();
        
        container.innerHTML = `
            <div style="margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <audio controls autoplay src="${localBlobUrl}"></audio>
                <button class="audio-btn" onclick="generateAudioForMessage('${msgId}', \`${textContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                    <i class="fas fa-sync-alt"></i> Re-run
                </button>
                <span style="color:var(--text-color); opacity:0.7; font-size:0.8em;">
                    Voice: ${voice} | Seed: ${newSeed} | 
                    <span id="upload-status-${msgId}">Uploading to catbox...</span>
                </span>
            </div>
        `;
        
        // Upload to catbox.moe for permanent hosting (if enabled)
const uploadToCatbox = document.getElementById('audio-upload-catbox')?.checked;

if (uploadToCatbox) {
    try {
        const formData = new FormData();
        formData.append('reqtype', 'fileupload');
        formData.append('fileToUpload', audioBlob, `audio_${msgId}_${newSeed}.mp3`);
        
        const uploadRes = await fetch(
            'https://corsproxy.io/?' + encodeURIComponent('https://catbox.moe/user/api.php'), 
            {
                method: 'POST',
                body: formData
            }
        );
        
        if (!uploadRes.ok) throw new Error(`Catbox upload failed: ${uploadRes.status}`);
        
        const catboxUrl = (await uploadRes.text()).trim();
        
        if (catboxUrl.startsWith('http')) {
            const statusSpan = document.getElementById(`upload-status-${msgId}`);
            if (statusSpan) {
                statusSpan.innerHTML = `<a href="${catboxUrl}" target="_blank" style="color:var(--accent);">Direct link</a>`;
            }
        } else {
            throw new Error("Invalid catbox response");
        }
        
    } catch (uploadError) {
        console.error("Catbox upload error:", uploadError);
        const statusSpan = document.getElementById(`upload-status-${msgId}`);
        if (statusSpan) {
            statusSpan.innerHTML = `<span style="color:orange; font-size:0.7em;">‚ö†Ô∏è Upload failed (local playback only)</span>`;
        }
    }
} else {
    // Catbox upload disabled - show local playback message
    const statusSpan = document.getElementById(`upload-status-${msgId}`);
    if (statusSpan) {
        statusSpan.innerHTML = `<span style="color:var(--text-color); opacity:0.7; font-size:0.7em;">Local playback only</span>`;
    }
}
        
    } catch (e) {
        showNotification("Audio generation failed: " + e.message);
        console.error("Audio error details:", e);
    } finally {
        audioBtn.innerHTML = originalText;
    }
}

    // --- Main Send Message Function ---
    async function sendMessage(regenerateSeed = null, previousContext = null) {
        const text = userInput.value.trim();
        if ((!text && uploadedFiles.length === 0 && !regenerateSeed) || isGenerating) return;

        let messagesPayload = [];

        if (regenerateSeed && previousContext) {
            messagesPayload = previousContext;
        } else {
            let userContent = [];
            
            if (text) userContent.push({ type: "text", text: text });
            
            uploadedFiles.forEach(f => {
                if (f.type === 'image') {
                    userContent.push({ type: "image_url", image_url: { url: f.content } });
                } else if (f.type === 'audio') {
                    userContent.push({ type: "text", text: `[User uploaded audio file: ${f.name}]` }); 
                } else {
                    userContent.push({ type: "text", text: `[File: ${f.name}]\n${f.content}` });
                }
            });

            const userMsgObj = { role: 'user', content: userContent };
            
            if(!regenerateSeed) {
                appendMessage('user', text, uploadedFiles);
                conversationHistory.push(userMsgObj);
                userInput.value = '';
                userInput.style.height = '44px';
                uploadedFiles = [];
                renderFilePreviews();
            }

            messagesPayload = [...conversationHistory];
        }

const emotion = document.getElementById('voice-style').value;
const customSystemMessage = document.getElementById('system-message').value.trim() || 'You are a helpful AI assistant';
const systemMsg = {
    role: 'system',
    content: `${customSystemMessage} ${emotion ? 'Voice and Response Style/Emotion: ' + emotion : ''}`,
    cache_control: { type: 'ephemeral' }
};

        const finalMessages = [systemMsg, ...messagesPayload];

        const token = tokenInput.value || USER_API_TOKEN;
        if (!token) {
            showNotification("Please enter your API Token in settings.");
            return;
        }

        const modelSelect = document.getElementById('model-select');
        let model = modelSelect.value;
        
        const seed = regenerateSeed !== null ? regenerateSeed : Math.floor(Math.random() * 10000);

        const requestBody = {
    messages: finalMessages,
    model: model,
    stream: true,
    seed: seed,
    temperature: 1,
    max_tokens: 4096
};

        isGenerating = true;
        sendBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        abortController = new AbortController();
        
        const aiMsgId = 'ai-msg-' + Date.now();
        const aiContentId = 'ai-content-' + aiMsgId;
        
        if(!regenerateSeed) {
            appendPlaceholder('ai', aiMsgId, aiContentId);
        }

        const aiContentDiv = document.getElementById(aiContentId);
        let accumulatedText = "";

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(requestBody),
                signal: abortController.signal
            });

            if (!response.ok) {
                let errorMsg = response.statusText || `Status ${response.status}`;
                try {
                    const errorObj = await response.json();
                    if (errorObj.error && errorObj.error.message) {
                        errorMsg = errorObj.error.message;
                    }
                } catch (e) {
                    // Could not parse JSON error, stick to status
                }
                throw new Error(errorMsg);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            let buffer = ''; 

            // Clear spinner before streaming starts if we have data
            let firstChunk = true;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;

                const lines = buffer.split('\n');
                buffer = lines.pop(); 

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('data: ') && trimmedLine !== 'data: [DONE]') {
                        if (firstChunk) {
                            aiContentDiv.innerHTML = ''; // Clear thinking spinner
                            firstChunk = false;
                        }
                        try {
                            const json = JSON.parse(trimmedLine.substring(6));
                            const delta = json.choices[0].delta;

                            if (delta.content) {
                                accumulatedText += delta.content;
                                aiContentDiv.innerHTML = marked.parse(accumulatedText);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                                
                                // Auto-update preview if panel is open
                                if (previewPanel.classList.contains('open')) {
                                    const messageWrapper = aiContentDiv.closest('.message-wrapper.ai');
                                    if (messageWrapper) {
                                        extractAllCodeFromMessage(messageWrapper);
                                        updatePreview();
                                    }
                                }
                            }
                            
                        } catch (e) {
                            console.error("Error parsing stream line", e);
                        }
                    }
                }
            }

            conversationHistory.push({ role: 'assistant', content: accumulatedText });

// Show audio button for on-demand generation
const audioBtn = document.getElementById(`audio-btn-${aiContentId}`);
if (audioBtn) {
    audioBtn.style.display = 'inline-block';
    audioBtn.onclick = function() {
        generateAudioForMessage(aiContentId, accumulatedText);
    };
}

        } catch (error) {
            if (error.name === 'AbortError') {
                aiContentDiv.innerHTML += `<br><span style="color:orange">[Stopped by user]</span>`;
            } else {
                // Clear spinner if error occurs
                if(aiContentDiv.innerHTML.includes('fa-spinner')) {
                     aiContentDiv.innerHTML = '';
                }
                aiContentDiv.innerHTML += `<div style="color:red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin-top: 5px;"><strong>Error:</strong> ${error.message}</div>`;
            }
        } finally {
            saveConversationToStorage();
            isGenerating = false;
            sendBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            abortController = null;
        }
    }


function appendMessage(role, text, files = []) {
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${role}`;
    
    const sender = role === 'user' ? 'You' : 'AI';
    const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    let fileHtml = '';
    if(files.length > 0) {
        files.forEach(f => {
            if(f.type === 'image') {
                fileHtml += `<img src="${f.content}" class="chat-image" alt="${f.name}">`;
            } else {
                fileHtml += `<div class="code-container"><div class="code-header">File: ${f.name}</div><pre>${f.type === 'text' ? escapeHtml(f.content.substring(0, 100)) + '...' : '[Binary Data]'}</pre></div>`;
            }
        });
    }

    let displayContent;
    if (role === 'ai') {
        displayContent = marked.parse(text || '');
    } else {
        displayContent = `<div style="white-space: pre-wrap;">${escapeHtml(text || '')}</div>`;
    }

// Add audio button for AI messages
let audioButtonHtml = '';
if (role === 'ai') {
    const showAudioButton = document.getElementById('audio-enable')?.checked;
    if (showAudioButton) {
        audioButtonHtml = `
            <button id="audio-btn-${msgId}" class="audio-btn" 
                    onclick="generateAudioForMessage('${msgId}', \`${(text || '').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                    style="margin-top:8px;">
                <i class="fas fa-volume-up"></i> Generate Audio
            </button>
            <div id="audio-container-${msgId}"></div>
        `;
    }
}

    wrapper.innerHTML = `
        <div class="message-sender">
            ${sender} 
            <span class="copy-msg-btn" onclick="copyMessage(this, '${msgId}')"><i class="fas fa-copy"></i></span>
        </div>
        <div class="message-bubble">
            <div id="${msgId}">${displayContent}</div>
            ${fileHtml}
            ${audioButtonHtml}
        </div>
    `;
    
    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function appendPlaceholder(role, id, contentId) {
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${role}`;
    wrapper.id = id;
    
    // Check if audio button should be shown
    const showAudioButton = document.getElementById('audio-enable')?.checked;
    const audioButtonHtml = showAudioButton ? `
    <button id="audio-btn-${contentId}" class="audio-btn" style="margin-top:8px; display:none;">
        <i class="fas fa-volume-up"></i> Generate Audio
    </button>
    <div id="audio-container-${contentId}"></div>
` : '';
    
    wrapper.innerHTML = `
        <div class="message-sender">
            AI <span class="copy-msg-btn" onclick="copyMessage(this, '${contentId}')"><i class="fas fa-copy"></i></span>
        </div>
        <div class="message-bubble">
            <div id="${contentId}"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>
            ${audioButtonHtml}
        </div>
    `;
    
    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}
    
    // --- Reset Functions ---
    function resetChat() {
        conversationHistory = [];
        chatContainer.innerHTML = `
            <div class="message-wrapper ai">
                <div class="message-sender">System</div>
                <div class="message-bubble">Chat history cleared. Start a new conversation!</div>
            </div>
        `;
        showNotification("Chat history cleared!");
        saveConversationToStorage();
    }
    
    function fullReset() {
        conversationHistory = [];
        uploadedFiles = [];
        isGenerating = false;
        currentPreviewCode = { html: '', css: '', js: '' };
        chatContainer.innerHTML = `
            <div class="message-wrapper ai">
                <div class="message-sender">System</div>
                <div class="message-bubble">Full reset complete. Welcome back!</div>
            </div>
        `;
        userInput.value = '';
        userInput.style.height = '44px';
        filePreview.innerHTML = '';
        if (USER_API_TOKEN) {
            tokenInput.value = USER_API_TOKEN;
        }
        previewPanel.classList.remove('open');
        showNotification("Full reset completed!");
        localStorage.removeItem('chatSessions');
        localStorage.removeItem('currentSessionId');
        sessions = {};
        currentSessionId = null;
        createNewSession();
    }
    
    // --- Session Functions ---
    function createNewSession() {
        const timestamp = new Date().toISOString();
        const title = `Session ${Object.keys(sessions).length + 1} - ${formatDateTime(timestamp)}`;
        
        const sessionId = 'session_' + Date.now();
        sessions[sessionId] = {
            id: sessionId,
            title: title,
            timestamp: timestamp,
            conversation: []
        };
        
        currentSessionId = sessionId;
        conversationHistory = [];
        
        chatContainer.innerHTML = `
            <div class="message-wrapper ai">
                <div class="message-sender">System</div>
                <div class="message-bubble">New session created: ${title}</div>
            </div>
        `;
        
        saveAllDataToStorage();
        loadSessionsToList();
        showNotification("New session created!");
        sessionPanel.classList.remove('open');
    }
    
    function loadSessionsToList() {
        sessionList.innerHTML = '';
        
        const sortedSessions = Object.values(sessions).sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        );
        
        sortedSessions.forEach(session => {
            const sessionItem = document.createElement('div');
            sessionItem.className = `session-item ${currentSessionId === session.id ? 'active' : ''}`;
            sessionItem.dataset.sessionId = session.id;
            
            if (!session.title) {
                session.title = `Session ${session.id.split('_')[1]} - ${formatDateTime(session.timestamp)}`;
            }
            
            sessionItem.innerHTML = `
                <div class="session-title" id="session-title-${session.id}">${session.title}</div>
                <div class="session-meta">${formatDateTime(session.timestamp)}</div>
                <div class="session-actions">
                    <button class="session-action-btn rename" data-session-id="${session.id}"><i class="fas fa-edit"></i></button>
                    <button class="session-action-btn delete" data-session-id="${session.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            sessionItem.addEventListener('click', function(e) {
                if (!e.target.closest('.session-action-btn')) {
                    loadSession(session.id);
                }
            });
            
            sessionList.appendChild(sessionItem);
        });
        
        document.querySelectorAll('.session-action-btn.rename').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const sessionId = btn.dataset.sessionId;
                renameSession(sessionId);
            });
        });
        
        document.querySelectorAll('.session-action-btn.delete').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const sessionId = btn.dataset.sessionId;
                deleteSession(sessionId);
            });
        });
    }
    
    function loadSession(sessionId) {
        if (!sessions[sessionId]) return;
        
        currentSessionId = sessionId;
        conversationHistory = sessions[sessionId].conversation || [];
        
        loadSessionsToList();
        
        chatContainer.innerHTML = '';
        
        if (conversationHistory.length === 0) {
            chatContainer.innerHTML = `
                <div class="message-wrapper ai">
                    <div class="message-sender">System</div>
                    <div class="message-bubble">Loaded session: ${sessions[sessionId].title}</div>
                </div>
            `;
        } else {
            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    let textContent = '';
                    if (Array.isArray(msg.content)) {
                        msg.content.forEach(item => {
                            if (item.type === 'text') {
                                textContent += item.text + '\n';
                            }
                        });
                        textContent = textContent.trim();
                    } else {
                        textContent = msg.content;
                    }
                    appendMessage('user', textContent);
                } else if (msg.role === 'assistant') {
                    appendMessage('ai', msg.content);
                }
            });
        }
        
        showNotification(`Loaded session: ${sessions[sessionId].title}`);
        saveAllDataToStorage();
        sessionPanel.classList.remove('open');
    }
    
    function renameSession(sessionId) {
        const session = sessions[sessionId];
        if (!session) return;
        
        const newTitle = prompt("Enter new title for session:", session.title);
        if (newTitle !== null && newTitle.trim() !== "") {
            session.title = newTitle.trim();
            saveAllDataToStorage();
            loadSessionsToList();
            showNotification("Session renamed!");
        }
    }
    
    function deleteSession(sessionId) {
        if (!sessions[sessionId]) return;
        
        if (confirm(`Are you sure you want to delete "${sessions[sessionId].title}"?`)) {
            delete sessions[sessionId];
            if (currentSessionId === sessionId) {
                if (Object.keys(sessions).length > 0) {
                    const firstSessionId = Object.keys(sessions)[0];
                    loadSession(firstSessionId);
                } else {
                    createNewSession();
                }
            }
            saveAllDataToStorage();
            loadSessionsToList();
            showNotification("Session deleted!");
        }
    }
    
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }
    
    // --- Storage Functions ---
    function saveAllDataToStorage() {
        const dataToSave = {
            sessions: sessions,
            currentSessionId: currentSessionId,
            timestamp: Date.now()
        };
        localStorage.setItem('chatSessions', JSON.stringify(dataToSave));
    }
    
    function loadAllDataFromStorage() {
        const savedData = localStorage.getItem('chatSessions');
        if (savedData) {
            try {
                const parsedData = JSON.parse(savedData);
                sessions = parsedData.sessions || {};
                currentSessionId = parsedData.currentSessionId || null;
                
                if (!currentSessionId || !sessions[currentSessionId]) {
                    if (Object.keys(sessions).length > 0) {
                        currentSessionId = Object.keys(sessions)[0];
                    } else {
                        createNewSession();
                        return;
                    }
                }
                
                loadSession(currentSessionId);
            } catch (e) {
                console.error("Failed to parse saved data:", e);
                sessions = {};
                currentSessionId = null;
                createNewSession();
            }
        } else {
            createNewSession();
        }
        
        loadSessionsToList();
    }
    
    function saveConversationToStorage() {
        if (currentSessionId && sessions[currentSessionId]) {
            sessions[currentSessionId].conversation = conversationHistory;
            saveAllDataToStorage();
        }
    }
    
    // --- Notification Function ---
    function showNotification(message) {
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(function() {
            notification.classList.remove('show');
        }, 3000);
    }

    // --- Keyboard shortcut for preview ---
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Shift + P to toggle preview
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
            e.preventDefault();
            if (previewPanel.classList.contains('open')) {
                previewPanel.classList.remove('open');
            } else {
                // Try to extract code from last AI message
                const lastAiMessage = chatContainer.querySelector('.message-wrapper.ai:last-child');
                if (lastAiMessage) {
                    extractAllCodeFromMessage(lastAiMessage);
                    updatePreview();
                    previewPanel.classList.add('open');
                } else {
                    showNotification('No code to preview!');
                }
            }
        }
    });

    // --- Debug: Log when script loads ---
    console.log("Chat application with live preview initialized successfully!");
    console.log("Press Ctrl+Shift+P to toggle preview of the last AI message");

    // Load available voices from API
    loadAvailableVoices();

    // --- Initialize App (MOVED HERE to run after all event listeners are set up) ---
    loadAllDataFromStorage();

</script>
</body>

</html>
