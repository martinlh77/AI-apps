<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollinations.ai Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.8rem);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            opacity: 0.9;
        }
        
        .timezone-display {
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: inline-block;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1200px) {
            body {
                padding: 20px;
            }
            header {
                padding: 30px 0;
                margin-bottom: 30px;
            }
            .dashboard {
                gap: 25px;
                margin-bottom: 30px;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .card {
                padding: 25px;
            }
            .card:hover {
                transform: translateY(-5px);
            }
        }
        
        .card-full {
            grid-column: 1 / -1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-header i {
            font-size: clamp(1.3rem, 4vw, 1.8rem);
            margin-right: 10px;
            color: #4dabf7;
        }
        
        .card-title {
            font-size: clamp(1.2rem, 3.5vw, 1.5rem);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        button {
            background: linear-gradient(to right, #4dabf7, #3bc9db);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            button {
                padding: 14px 20px;
            }
            button:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            }
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .result-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            max-height: 500px;
            overflow: auto;
        }
        
        @media (min-width: 768px) {
            .result-container {
                padding: 20px;
                max-height: 600px;
            }
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .result-title {
            font-size: clamp(1rem, 3vw, 1.3rem);
            font-weight: 600;
        }
        
        .copy-btn {
            background: rgba(77, 171, 247, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            width: auto;
            margin: 0;
        }
        
        .result-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Courier New', monospace;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            line-height: 1.6;
        }
        
        .balance-value {
            font-size: clamp(2rem, 8vw, 3rem);
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: #51cf66;
            text-shadow: 0 2px 8px rgba(81, 207, 102, 0.3);
        }
        
        .profile-item {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            gap: 5px;
        }
        
        @media (min-width: 500px) {
            .profile-item {
                flex-direction: row;
                gap: 0;
            }
        }
        
        .profile-label {
            font-weight: 600;
            min-width: 150px;
            color: #4dabf7;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        .profile-value {
            flex: 1;
            word-break: break-word;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        /* Improved table scrolling */
        .usage-table-container {
            position: relative;
            margin-top: 15px;
        }
        
        .usage-table-wrapper {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 600px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (min-width: 768px) {
            .usage-table-wrapper {
                max-height: 70vh;
            }
        }
        
        .usage-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        
        .usage-table th,
        .usage-table td {
            padding: 10px 6px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            background: rgba(0, 0, 0, 0.3);
        }
        
        .usage-table th {
            background: rgba(77, 171, 247, 0.3);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .usage-table th:hover {
            background: rgba(77, 171, 247, 0.4);
        }
        
        .usage-table th.sorted-asc::after {
            content: ' ▲';
            color: #51cf66;
        }
        
        .usage-table th.sorted-desc::after {
            content: ' ▼';
            color: #51cf66;
        }
        
        .usage-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .cost-cell {
            color: #51cf66;
            font-weight: 600;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .summary-stats {
                gap: 15px;
            }
        }
        
        .stat-box {
            background: rgba(77, 171, 247, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .stat-box {
                padding: 20px;
            }
        }
        
        .stat-value {
            font-size: clamp(1.3rem, 5vw, 2rem);
            font-weight: 700;
            color: #4dabf7;
            margin: 10px 0;
            word-break: break-word;
        }
        
        .stat-label {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            opacity: 0.9;
        }
        
        .error, .success {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid #ff6b6b;
        }
        
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            border-left: 4px solid #51cf66;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
        }
        
        @media (min-width: 768px) {
            .loading {
                padding: 40px;
            }
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4dabf7;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @media (min-width: 768px) {
            .spinner {
                width: 50px;
                height: 50px;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-buttons button {
            margin: 0;
        }
        
        .info-box {
            background: rgba(77, 171, 247, 0.15);
            border-left: 4px solid #4dabf7;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            font-size: clamp(1rem, 3vw, 1.2rem);
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .info-box li {
            margin: 5px 0;
        }
        
        footer {
            text-align: center;
            padding: 20px 10px;
            margin-top: 30px;
            opacity: 0.8;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
        }
        
        .format-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .format-toggle button {
            margin: 0;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .format-toggle button.active {
            background: linear-gradient(to right, #4dabf7, #3bc9db);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 500px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 768px) {
            .filters-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Improve scrollbar styling */
        .result-container::-webkit-scrollbar,
        .usage-table-wrapper::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }
        
        .result-container::-webkit-scrollbar-track,
        .usage-table-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .result-container::-webkit-scrollbar-thumb,
        .usage-table-wrapper::-webkit-scrollbar-thumb {
            background: rgba(77, 171, 247, 0.6);
            border-radius: 10px;
        }
        
        .result-container::-webkit-scrollbar-thumb:hover,
        .usage-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(77, 171, 247, 0.8);
        }
        
        /* Firefox scrollbar */
        .result-container,
        .usage-table-wrapper {
            scrollbar-width: thin;
            scrollbar-color: rgba(77, 171, 247, 0.6) rgba(255, 255, 255, 0.1);
        }
        
        /* Touch-friendly tap targets */
        @media (max-width: 767px) {
            button, .copy-btn {
                min-height: 44px;
            }
            
            input, select {
                min-height: 44px;
            }
        }
        
        /* Column visibility controls */
        .column-controls {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .column-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .column-controls-header h3 {
            font-size: clamp(1rem, 3vw, 1.2rem);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .column-controls-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .column-controls-content.expanded {
            max-height: 500px;
            margin-top: 10px;
        }
        
        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .column-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .column-checkbox input[type="checkbox"] {
            width: auto;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        
        .column-checkbox label {
            margin: 0;
            cursor: pointer;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
        
        .column-controls-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .column-controls-buttons button {
            margin: 0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            padding: 8px 12px;
        }
        
        .usage-table th.hidden,
        .usage-table td.hidden {
            display: none;
        }
        
        /* Record count info */
        .record-info {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(77, 171, 247, 0.1);
            border-radius: 6px;
            opacity: 0.9;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }
        
        /* Scroll hint for desktop */
        .scroll-hint {
            display: none;
            text-align: center;
            padding: 8px;
            background: rgba(77, 171, 247, 0.2);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            animation: fadeIn 0.5s ease-in;
        }
        
        @media (min-width: 768px) {
            .scroll-hint.show {
                display: block;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Pollinations.ai</h1>
            <p class="subtitle">Account Dashboard</p>
            <div class="timezone-display">
                <i class="fas fa-clock"></i> <span id="current-time"></span>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- Profile Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-circle"></i>
                    <h2 class="card-title">Profile</h2>
                </div>
                
                <div class="form-group">
                    <label for="api-key">
                        <i class="fas fa-key"></i> API Key:
                    </label>
                    <input type="password" id="api-key" placeholder="sk_your_api_key_here">
                </div>
                
                <button id="fetch-profile-btn">
                    <i class="fas fa-sync-alt"></i> Fetch Profile
                </button>
                
                <div class="result-container">
                    <div class="result-header">
                        <div class="result-title">Information</div>
                    </div>
                    <div class="result-content" id="profile-result">
                        <p style="text-align: center; opacity: 0.7;">Enter API key and fetch</p>
                    </div>
                </div>
            </div>
            
            <!-- Balance Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-wallet"></i>
                    <h2 class="card-title">Balance</h2>
                </div>
                
                <button id="fetch-balance-btn">
                    <i class="fas fa-sync-alt"></i> Fetch Balance
                </button>
                
                <div class="balance-value" id="balance-value">
                    $0.00
                </div>
                
                <div class="result-container">
                    <div class="result-header">
                        <div class="result-title">Details</div>
                    </div>
                    <div class="result-content" id="balance-result">
                        <p style="text-align: center; opacity: 0.7;">Click to see details</p>
                    </div>
                </div>
            </div>
            
            <!-- Usage History Card -->
            <div class="card card-full">
                <div class="card-header">
                    <i class="fas fa-history"></i>
                    <h2 class="card-title">Usage History</h2>
                </div>
                
                <div class="format-toggle">
                    <button id="json-format-btn" class="active">
                        <i class="fas fa-code"></i> JSON
                    </button>
                    <button id="csv-format-btn">
                        <i class="fas fa-table"></i> CSV
                    </button>
                </div>
                
                <div class="filters-grid">
                    <div class="form-group">
                        <label for="limit">
                            <i class="fas fa-list-ol"></i> Records:
                        </label>
                        <input type="number" id="limit" min="1" max="10000" value="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="start-date">
                            <i class="fas fa-calendar-alt"></i> After:
                        </label>
                        <input type="datetime-local" id="start-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="end-date">
                            <i class="fas fa-calendar-check"></i> Before:
                        </label>
                        <input type="datetime-local" id="end-date">
                    </div>
                </div>
                
                <button id="fetch-usage-btn">
                    <i class="fas fa-sync-alt"></i> Fetch Usage History
                </button>
                
                <!-- Column Visibility Controls -->
                <div class="column-controls">
                    <div class="column-controls-header" id="column-controls-toggle">
                        <h3>
                            <i class="fas fa-columns"></i> Column Visibility
                        </h3>
                        <i class="fas fa-chevron-down" id="column-controls-icon"></i>
                    </div>
                    <div class="column-controls-content" id="column-controls-content">
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-timestamp" checked>
                            <label for="col-timestamp">Time (ET)</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-type" checked>
                            <label for="col-type">Type</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-model" checked>
                            <label for="col-model">Model</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-api-key" checked>
                            <label for="col-api-key">API Key</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-key-type" checked>
                            <label for="col-key-type">Key Type</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-in-text" checked>
                            <label for="col-in-text">In Text</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-in-cache" checked>
                            <label for="col-in-cache">In Cache</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-in-audio" checked>
                            <label for="col-in-audio">In Audio</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-in-image" checked>
                            <label for="col-in-image">In Image</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-out-text" checked>
                            <label for="col-out-text">Out Text</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-out-reason" checked>
                            <label for="col-out-reason">Out Reason</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-out-audio" checked>
                            <label for="col-out-audio">Out Audio</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-out-image" checked>
                            <label for="col-out-image">Out Image</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-cost" checked>
                            <label for="col-cost">Cost</label>
                        </div>
                        <div class="column-checkbox">
                            <input type="checkbox" id="col-response-time" checked>
                            <label for="col-response-time">Response Time</label>
                        </div>
                        <div class="column-controls-buttons">
                            <button id="show-all-columns">
                                <i class="fas fa-eye"></i> Show All
                            </button>
                            <button id="hide-all-columns">
                                <i class="fas fa-eye-slash"></i> Hide All
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="export-buttons">
                    <button id="export-csv-btn" disabled>
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button id="export-json-btn" disabled>
                        <i class="fas fa-file-code"></i> JSON
                    </button>
                </div>
                
                <div id="scroll-hint" class="scroll-hint">
                    <i class="fas fa-arrows-alt"></i> Table scrolls both horizontally and vertically - use your mouse or trackpad to navigate
                </div>
                
                <div id="usage-result">
                    <p style="text-align: center; opacity: 0.7; padding: 40px;">Configure and fetch usage history</p>
                </div>
            </div>
            
            <!-- Summary Card -->
            <div class="card card-full">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    <h2 class="card-title">Summary</h2>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-label">Transactions</div>
                        <div class="stat-value" id="total-transactions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Cost</div>
                        <div class="stat-value" id="total-cost">$0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Input Tokens</div>
                        <div class="stat-value" id="total-input-tokens">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Output Tokens</div>
                        <div class="stat-value" id="total-output-tokens">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Avg Response</div>
                        <div class="stat-value" id="avg-response-time">0ms</div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3><i class="fas fa-info-circle"></i> Quick Guide</h3>
                    <ul>
                        <li>Enter your API key (starts with sk_)</li>
                        <li>Choose JSON or CSV format</li>
                        <li>Set records limit (1-10000)</li>
                        <li>Optionally filter by date</li>
                        <li>Click column headers to sort</li>
                        <li>Show/hide columns as needed</li>
                        <li>Table scrolls independently (both directions)</li>
                        <li>Export data as CSV or JSON</li>
                        <li>All times shown in Eastern Time (AM/PM)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <footer>
            <p><i class="fas fa-shield-alt"></i> Your API key is never stored</p>
        </footer>
    </div>

    <script>
        // Global variables
        let cachedUsageData = null;
        let currentFormat = 'json';
        let sortColumn = null;
        let sortDirection = 'asc';
        const BASE_URL = 'https://gen.pollinations.ai/api/account';
        const DEFAULT_API_KEY = 'sk_srRmBsaXJzbvAeNQnUK3aPSc4LXVT8Pt'; // Add your default API key here (e.g., 'sk_your_key_here')
        
        // Column definitions
        const columns = [
            { id: 'timestamp', label: 'Time (ET)', field: 'timestamp', sortable: true },
            { id: 'type', label: 'Type', field: 'type', sortable: true },
            { id: 'model', label: 'Model', field: 'model', sortable: true },
            { id: 'api-key', label: 'API Key', field: 'api_key', sortable: true },
            { id: 'key-type', label: 'Key Type', field: 'api_key_type', sortable: true },
            { id: 'in-text', label: 'In Text', field: 'input_text_tokens', sortable: true, numeric: true },
            { id: 'in-cache', label: 'In Cache', field: 'input_cached_tokens', sortable: true, numeric: true },
            { id: 'in-audio', label: 'In Audio', field: 'input_audio_tokens', sortable: true, numeric: true },
            { id: 'in-image', label: 'In Image', field: 'input_image_tokens', sortable: true, numeric: true },
            { id: 'out-text', label: 'Out Text', field: 'output_text_tokens', sortable: true, numeric: true },
            { id: 'out-reason', label: 'Out Reason', field: 'output_reasoning_tokens', sortable: true, numeric: true },
            { id: 'out-audio', label: 'Out Audio', field: 'output_audio_tokens', sortable: true, numeric: true },
            { id: 'out-image', label: 'Out Image', field: 'output_image_tokens', sortable: true, numeric: true },
            { id: 'cost', label: 'Cost', field: 'cost_usd', sortable: true, numeric: true },
            { id: 'response-time', label: 'ms', field: 'response_time_ms', sortable: true, numeric: true }
        ];
        
        // DOM Elements
        const apiKeyInput = document.getElementById('api-key');
        const fetchProfileBtn = document.getElementById('fetch-profile-btn');
        const fetchBalanceBtn = document.getElementById('fetch-balance-btn');
        const fetchUsageBtn = document.getElementById('fetch-usage-btn');
        const jsonFormatBtn = document.getElementById('json-format-btn');
        const csvFormatBtn = document.getElementById('csv-format-btn');
        const exportCSVBtn = document.getElementById('export-csv-btn');
        const exportJSONBtn = document.getElementById('export-json-btn');
        const limitInput = document.getElementById('limit');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const profileResult = document.getElementById('profile-result');
        const balanceValue = document.getElementById('balance-value');
        const balanceResult = document.getElementById('balance-result');
        const usageResult = document.getElementById('usage-result');
        const currentTimeDisplay = document.getElementById('current-time');
        const columnControlsToggle = document.getElementById('column-controls-toggle');
        const columnControlsContent = document.getElementById('column-controls-content');
        const columnControlsIcon = document.getElementById('column-controls-icon');
        const showAllColumnsBtn = document.getElementById('show-all-columns');
        const hideAllColumnsBtn = document.getElementById('hide-all-columns');
        const scrollHint = document.getElementById('scroll-hint');

        // Update current time display
        function updateTime() {
            const now = new Date();
            const options = {
                timeZone: 'America/New_York',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            currentTimeDisplay.textContent = now.toLocaleString('en-US', options);
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Set default API key if configured
        if (DEFAULT_API_KEY) {
            apiKeyInput.value = DEFAULT_API_KEY;
        }

        // Set default dates to last 30 days
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        function formatDateForInput(date) {
            const pad = (n) => n < 10 ? '0' + n : n;
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
        
        startDateInput.value = formatDateForInput(thirtyDaysAgo);
        endDateInput.value = formatDateForInput(now);

        // Convert UTC timestamp to Eastern Time with AM/PM
        function convertToEasternTimeAMPM(timestamp) {
            let date;
            if (timestamp.includes('T') || timestamp.includes('Z')) {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp + ' UTC');
            }
            
            const options = {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Parse CSV to JSON
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                data.push(obj);
            }
            
            return data;
        }

        // Column visibility controls
        columnControlsToggle.addEventListener('click', () => {
            columnControlsContent.classList.toggle('expanded');
            columnControlsIcon.classList.toggle('fa-chevron-down');
            columnControlsIcon.classList.toggle('fa-chevron-up');
        });

        showAllColumnsBtn.addEventListener('click', () => {
            columns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.id}`);
                if (checkbox) checkbox.checked = true;
            });
            if (cachedUsageData) displayUsage(cachedUsageData);
        });

        hideAllColumnsBtn.addEventListener('click', () => {
            columns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.id}`);
                if (checkbox) checkbox.checked = false;
            });
            if (cachedUsageData) displayUsage(cachedUsageData);
        });

        // Add change listeners to all column checkboxes
        columns.forEach(col => {
            const checkbox = document.getElementById(`col-${col.id}`);
            if (checkbox) {
                checkbox.addEventListener('change', () => {
                    if (cachedUsageData) displayUsage(cachedUsageData);
                });
            }
        });

        // Check if column is visible
        function isColumnVisible(columnId) {
            const checkbox = document.getElementById(`col-${columnId}`);
            return checkbox ? checkbox.checked : true;
        }

        // Event Listeners
        fetchProfileBtn.addEventListener('click', fetchProfile);
        fetchBalanceBtn.addEventListener('click', fetchBalance);
        fetchUsageBtn.addEventListener('click', fetchUsage);
        jsonFormatBtn.addEventListener('click', () => switchFormat('json'));
        csvFormatBtn.addEventListener('click', () => switchFormat('csv'));
        exportCSVBtn.addEventListener('click', () => exportData('csv'));
        exportJSONBtn.addEventListener('click', () => exportData('json'));

        // Switch format
        function switchFormat(format) {
            currentFormat = format;
            jsonFormatBtn.classList.toggle('active', format === 'json');
            csvFormatBtn.classList.toggle('active', format === 'csv');
            
            if (cachedUsageData) {
                displayUsage(cachedUsageData);
            }
        }

        // Fetch Profile
        async function fetchProfile() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showMessage(profileResult, 'Please enter your API key', 'error');
                return;
            }
            
            try {
                showLoading(profileResult);
                
                const url = `${BASE_URL}/profile?format=json&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayProfile(data);
            } catch (error) {
                showMessage(profileResult, 'Error: ' + error.message, 'error');
            }
        }

        // Fetch Balance
        async function fetchBalance() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showMessage(balanceResult, 'Please enter your API key', 'error');
                return;
            }
            
            try {
                showLoading(balanceResult);
                
                const url = `${BASE_URL}/balance?format=json&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayBalance(data);
            } catch (error) {
                showMessage(balanceResult, 'Error: ' + error.message, 'error');
            }
        }

        // Fetch Usage
        async function fetchUsage() {
            const apiKey = apiKeyInput.value.trim();
            const limit = limitInput.value;
            const format = currentFormat;
            
            if (!apiKey) {
                showMessage(usageResult, 'Please enter your API key', 'error');
                return;
            }
            
            try {
                showLoading(usageResult);
                
                const url = `${BASE_URL}/usage?format=${format}&limit=${limit}&key=${apiKey}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let data;
                if (format === 'json') {
                    data = await response.json();
                } else {
                    const csvText = await response.text();
                    const usageArray = parseCSV(csvText);
                    data = {
                        usage: usageArray,
                        count: usageArray.length
                    };
                }
                
                // Apply client-side date filtering
                let filteredUsage = data.usage;
                if (startDateInput.value || endDateInput.value) {
                    const startTime = startDateInput.value ? new Date(startDateInput.value).getTime() : 0;
                    const endTime = endDateInput.value ? new Date(endDateInput.value).getTime() : Infinity;
                    
                    filteredUsage = data.usage.filter(item => {
                        const timestamp = item.timestamp;
                        let itemTime;
                        
                        if (timestamp.includes('T') || timestamp.includes('Z')) {
                            itemTime = new Date(timestamp).getTime();
                        } else {
                            itemTime = new Date(timestamp + ' UTC').getTime();
                        }
                        
                        return itemTime >= startTime && itemTime <= endTime;
                    });
                }
                
                const filteredData = {
                    usage: filteredUsage,
                    count: filteredUsage.length,
                    totalCount: data.count
                };
                
                cachedUsageData = filteredData;
                sortColumn = null; // Reset sort when fetching new data
                sortDirection = 'asc';
                displayUsage(filteredData);
                updateSummaryStats(filteredData);
                exportCSVBtn.disabled = false;
                exportJSONBtn.disabled = false;
                
                // Show scroll hint
                scrollHint.classList.add('show');
                setTimeout(() => {
                    scrollHint.classList.remove('show');
                }, 5000);
            } catch (error) {
                showMessage(usageResult, 'Error: ' + error.message, 'error');
            }
        }

        // Sort data
        function sortData(data, column, direction) {
            const sorted = [...data];
            const col = columns.find(c => c.id === column);
            
            if (!col) return sorted;
            
            sorted.sort((a, b) => {
                let aVal = a[col.field];
                let bVal = b[col.field];
                
                // Handle timestamps specially
                if (col.field === 'timestamp') {
                    aVal = new Date(aVal.includes('T') || aVal.includes('Z') ? aVal : aVal + ' UTC').getTime();
                    bVal = new Date(bVal.includes('T') || bVal.includes('Z') ? bVal : bVal + ' UTC').getTime();
                } else if (col.numeric) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sorted;
        }

        // Handle column header click for sorting
        function handleColumnClick(columnId) {
            if (sortColumn === columnId) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnId;
                sortDirection = 'asc';
            }
            
            if (cachedUsageData) {
                const sortedData = {
                    ...cachedUsageData,
                    usage: sortData(cachedUsageData.usage, columnId, sortDirection)
                };
                displayUsage(sortedData);
            }
        }

        // Display Profile
        function displayProfile(data) {
            let html = '';
            
            const profileFields = {
                name: 'Name',
                email: 'Email',
                githubUsername: 'GitHub',
                tier: 'Tier',
                createdAt: 'Created'
            };
            
            for (const [key, label] of Object.entries(profileFields)) {
                let value = data[key] || 'N/A';
                
                if (key === 'createdAt' && value !== 'N/A') {
                    value = convertToEasternTimeAMPM(value);
                }
                
                html += `
                    <div class="profile-item">
                        <span class="profile-label">${label}:</span>
                        <span class="profile-value">${value}</span>
                    </div>
                `;
            }
            
            profileResult.innerHTML = html;
        }

        // Display Balance
        function displayBalance(data) {
            const balance = data.balance || 0;
            balanceValue.textContent = `$${balance.toFixed(2)}`;
            
            let html = `
                <div style="text-align: center;">
                    <p style="font-size: clamp(1rem, 3vw, 1.2rem); margin-bottom: 15px;">
                        Available: <strong style="color: #51cf66;">$${balance.toFixed(8)}</strong>
                    </p>
                    <p style="opacity: 0.8; font-size: clamp(0.8rem, 2vw, 0.9rem);">
                        Current Pollen balance
                    </p>
                </div>
            `;
            
            balanceResult.innerHTML = html;
        }

        // Display Usage
        function displayUsage(data) {
            if (!data.usage || data.usage.length === 0) {
                usageResult.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 40px;">No records found</p>';
                return;
            }
            
            let html = `
                <div class="usage-table-container">
                    <div class="usage-table-wrapper">
                        <table class="usage-table">
                            <thead>
                                <tr>
            `;
            
            // Generate headers with visibility and sort indicators
            columns.forEach(col => {
                const visible = isColumnVisible(col.id);
                const sortClass = sortColumn === col.id ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                const hiddenClass = visible ? '' : 'hidden';
                
                html += `
                    <th class="${sortClass} ${hiddenClass}" 
                        onclick="handleColumnClick('${col.id}')"
                        data-column="${col.id}">
                        ${col.label}
                    </th>
                `;
            });
            
            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.usage.forEach(item => {
                html += '<tr>';
                
                columns.forEach(col => {
                    const visible = isColumnVisible(col.id);
                    const hiddenClass = visible ? '' : 'hidden';
                    let value = item[col.field];
                    let cellClass = '';
                    
                    // Format values based on column
                    if (col.field === 'timestamp') {
                        value = convertToEasternTimeAMPM(value);
                    } else if (col.field === 'cost_usd') {
                        value = '$' + parseFloat(value || 0).toFixed(6);
                        cellClass = 'cost-cell';
                    } else if (col.numeric) {
                        value = (parseInt(value) || 0).toLocaleString();
                    } else if (!value) {
                        value = '-';
                    }
                    
                    const style = col.field === 'timestamp' ? 'white-space: nowrap;' : 
                                 col.field === 'model' ? 'max-width: 200px; overflow: hidden; text-overflow: ellipsis;' : '';
                    const title = col.field === 'model' ? `title="${item[col.field] || '-'}"` : '';
                    
                    html += `<td class="${cellClass} ${hiddenClass}" style="${style}" ${title}>${value}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="record-info">
                    <i class="fas fa-info-circle"></i> 
                    Showing ${data.usage.length} record${data.usage.length !== 1 ? 's' : ''}${data.totalCount ? ` (of ${data.totalCount} total)` : ''}
                </div>
            `;
            
            usageResult.innerHTML = html;
        }

        // Update Summary Stats
        function updateSummaryStats(data) {
            if (!data.usage || data.usage.length === 0) {
                document.getElementById('total-transactions').textContent = '0';
                document.getElementById('total-cost').textContent = '$0.00';
                document.getElementById('total-input-tokens').textContent = '0';
                document.getElementById('total-output-tokens').textContent = '0';
                document.getElementById('avg-response-time').textContent = '0ms';
                return;
            }
            
            let totalCost = 0;
            let totalInputTokens = 0;
            let totalOutputTokens = 0;
            let totalResponseTime = 0;
            let responseTimeCount = 0;
            
            data.usage.forEach(item => {
                totalCost += parseFloat(item.cost_usd || 0);
                // Sum all input token types
                totalInputTokens += parseInt(item.input_text_tokens || 0);
                totalInputTokens += parseInt(item.input_cached_tokens || 0);
                totalInputTokens += parseInt(item.input_audio_tokens || 0);
                totalInputTokens += parseInt(item.input_image_tokens || 0);
                // Sum all output token types
                totalOutputTokens += parseInt(item.output_text_tokens || 0);
                totalOutputTokens += parseInt(item.output_reasoning_tokens || 0);
                totalOutputTokens += parseInt(item.output_audio_tokens || 0);
                totalOutputTokens += parseInt(item.output_image_tokens || 0);
                
                if (item.response_time_ms) {
                    totalResponseTime += parseInt(item.response_time_ms);
                    responseTimeCount++;
                }
            });
            
            const avgResponseTime = responseTimeCount > 0 ? Math.round(totalResponseTime / responseTimeCount) : 0;
            
            document.getElementById('total-transactions').textContent = data.usage.length.toLocaleString();
            document.getElementById('total-cost').textContent = `$${totalCost.toFixed(6)}`;
            document.getElementById('total-input-tokens').textContent = totalInputTokens.toLocaleString();
            document.getElementById('total-output-tokens').textContent = totalOutputTokens.toLocaleString();
            document.getElementById('avg-response-time').textContent = `${avgResponseTime}ms`;
        }

        // Export Data
        function exportData(format) {
            if (!cachedUsageData) {
                alert('Please fetch usage data first');
                return;
            }
            
            let content, filename, mimeType;
            
            if (format === 'csv') {
                const headers = [
                    'Timestamp (ET)',
                    'Timestamp (UTC)',
                    'Type',
                    'Model',
                    'API Key',
                    'API Key Type',
                    'Meter Source',
                    'Input Text Tokens',
                    'Input Cached Tokens',
                    'Input Audio Tokens',
                    'Input Image Tokens',
                    'Output Text Tokens',
                    'Output Reasoning Tokens',
                    'Output Audio Tokens',
                    'Output Image Tokens',
                    'Cost (USD)',
                    'Response Time (ms)'
                ];
                const rows = cachedUsageData.usage.map(item => [
                    convertToEasternTimeAMPM(item.timestamp),
                    item.timestamp,
                    item.type || '',
                    item.model || '',
                    item.api_key || '',
                    item.api_key_type || '',
                    item.meter_source || '',
                    item.input_text_tokens || 0,
                    item.input_cached_tokens || 0,
                    item.input_audio_tokens || 0,
                    item.input_image_tokens || 0,
                    item.output_text_tokens || 0,
                    item.output_reasoning_tokens || 0,
                    item.output_audio_tokens || 0,
                    item.output_image_tokens || 0,
                    item.cost_usd || 0,
                    item.response_time_ms || ''
                ]);
                
                content = [headers, ...rows].map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');
                
                filename = `pollinations-usage-${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            } else {
                const dataWithET = {
                    ...cachedUsageData,
                    usage: cachedUsageData.usage.map(item => ({
                        ...item,
                        timestamp_et: convertToEasternTimeAMPM(item.timestamp),
                        timestamp_utc: item.timestamp
                    }))
                };
                
                content = JSON.stringify(dataWithET, null, 2);
                filename = `pollinations-usage-${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const originalText = format === 'csv' ? exportCSVBtn.innerHTML : exportJSONBtn.innerHTML;
            const btn = format === 'csv' ? exportCSVBtn : exportJSONBtn;
            btn.innerHTML = '<i class="fas fa-check"></i> Done!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Show Loading
        function showLoading(element) {
            element.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            `;
        }

        // Show Message
        function showMessage(element, message, type = 'error') {
            const className = type === 'error' ? 'error' : 'success';
            element.innerHTML = `<div class="${className}"><i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}</div>`;
        }
    </script>
</body>
</html>
