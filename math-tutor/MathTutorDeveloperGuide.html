<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Tutor - Developer Guide</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --bg-secondary: #16213e;
            --accent: #d4af37;
            --text: #f0f0f0;
            --text-muted: #aaa;
            --code-bg: #0d0d1a;
            --border: #333;
            --primary: #00d4ff;
            --secondary: #ff6b6b;
            --success: #27ae60;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text);
            line-height: 1.6;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-color));
            border-bottom: 3px solid var(--accent);
            margin-bottom: 40px;
        }

        header h1 {
            color: var(--accent);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        h2 {
            color: var(--accent);
            font-size: 1.8rem;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        h3 {
            color: var(--primary);
            font-size: 1.3rem;
            margin: 30px 0 15px;
        }

        h4 {
            color: var(--text);
            font-size: 1.1rem;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin-bottom: 8px;
        }

        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--primary);
        }

        pre {
            background: var(--code-bg);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid var(--border);
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text);
            display: block;
            white-space: pre;
        }

        .note {
            background: rgba(212, 175, 55, 0.1);
            border-left: 4px solid var(--accent);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .note-title {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .warning {
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-title {
            color: var(--secondary);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .success {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(212, 175, 55, 0.2);
            color: var(--accent);
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .color-swatch {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 8px;
            border: 1px solid var(--border);
        }

        .toc {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .toc h3 {
            margin-top: 0;
            color: var(--accent);
        }

        .toc ul {
            margin: 10px 0 0 20px;
        }

        .toc a {
            color: var(--primary);
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .architecture-diagram {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            font-family: 'Fira Code', monospace;
            border: 1px solid var(--border);
        }

        .architecture-diagram .flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .architecture-diagram .box {
            background: var(--code-bg);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .architecture-diagram .arrow {
            color: var(--accent);
            font-size: 1.2rem;
        }

        .file-tree {
            background: var(--code-bg);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
        }

        .file-tree .folder {
            color: var(--accent);
        }

        .file-tree .file {
            color: var(--text);
        }

        .file-tree .new {
            color: var(--success);
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            pre {
                padding: 15px;
                font-size: 0.85rem;
            }

            .architecture-diagram .flow {
                flex-direction: column;
            }

            .architecture-diagram .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>

<header>
    <h1>üéì Math Tutor Developer Guide</h1>
    <p>Complete Technical Documentation - Version 3.0</p>
</header>

<div class="container">

    <nav class="toc">
        <h3>üìã Table of Contents</h3>
        <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#file-structure">File Structure</a></li>
            <li><a href="#architecture">Architecture</a></li>
            <li><a href="#features">Features</a></li>
            <li><a href="#theming">Light/Dark Theming</a></li>
            <li><a href="#content-filter">Content Filter System</a></li>
            <li><a href="#drawing-tool">Drawing Tool</a></li>
            <li><a href="#image-upload">Image Upload & Vision</a></li>
            <li><a href="#conversations">Conversation Management</a></li>
            <li><a href="#visualizations">Adding New Visualizations</a></li>
            <li><a href="#colors">Color Reference</a></li>
            <li><a href="#api">API Integration</a></li>
        </ul>
    </nav>

    <section id="overview">
        <h2>Overview</h2>
        <p>
            The Math Tutor app is a comprehensive AI-powered mathematics learning assistant that features:
        </p>
        <ul>
            <li><strong>Multi-model AI:</strong> Uses Grok for tutoring, GPT-4 Vision for image analysis, and specialized models for coding and search</li>
            <li><strong>Python Visualizations:</strong> Pyodide-powered matplotlib graphs rendered in-browser</li>
            <li><strong>Interactive Drawing:</strong> Built-in drawing tool for student work</li>
            <li><strong>Image Upload:</strong> Camera and file upload for checking handwritten work</li>
            <li><strong>Theme Support:</strong> Light and dark modes with theme-aware graphs</li>
            <li><strong>Conversation Saving:</strong> Local storage of chat history with images</li>
            <li><strong>Content Filtering:</strong> Configurable JSON-based word/phrase filtering</li>
            <li><strong>Multi-language:</strong> Support for 12+ languages with dynamic translation</li>
        </ul>
    </section>

    <section id="file-structure">
        <h2>File Structure</h2>
        <div class="file-tree">
<pre>
math-tutor/
‚îú‚îÄ‚îÄ index.html                    # Main application HTML
‚îú‚îÄ‚îÄ manifest.json                 # App configuration
‚îú‚îÄ‚îÄ <span class="folder">core/</span>
‚îÇ   ‚îú‚îÄ‚îÄ tutor-engine.js          # Main controller (updated)
‚îÇ   ‚îú‚îÄ‚îÄ python-engine.js         # Pyodide integration (updated)
‚îÇ   ‚îú‚îÄ‚îÄ message-parser.js        # Content rendering (updated)
‚îÇ   ‚îú‚îÄ‚îÄ language-manager.js      # i18n system
‚îÇ   ‚îú‚îÄ‚îÄ app-loader.js            # Dynamic loading
‚îÇ   ‚îú‚îÄ‚îÄ <span class="new">content-filter.js</span>       # NEW: Word/phrase filtering
‚îÇ   ‚îú‚îÄ‚îÄ <span class="new">drawing-tool.js</span>        # NEW: Canvas drawing system
‚îÇ   ‚îî‚îÄ‚îÄ <span class="new">conversation-manager.js</span> # NEW: Save/load conversations
‚îú‚îÄ‚îÄ <span class="folder">styles/</span>
‚îÇ   ‚îú‚îÄ‚îÄ core.css                 # Main styles (updated)
‚îÇ   ‚îú‚îÄ‚îÄ mobile.css               # Responsive styles (updated)
‚îÇ   ‚îî‚îÄ‚îÄ <span class="new">drawing.css</span>            # NEW: Drawing tool styles
‚îú‚îÄ‚îÄ <span class="folder">data/</span>
‚îÇ   ‚îú‚îÄ‚îÄ languages.json           # Translation strings
‚îÇ   ‚îî‚îÄ‚îÄ <span class="new">content-filter.json</span>    # NEW: Blocked words/phrases
‚îî‚îÄ‚îÄ MathTutorDeveloperGuide.html # This document
</pre>
        </div>
    </section>

    <section id="architecture">
        <h2>Architecture</h2>
        
        <div class="architecture-diagram">
            <div class="flow">
                <div class="box">User Input</div>
                <span class="arrow">‚Üí</span>
                <div class="box">Content Filter</div>
                <span class="arrow">‚Üí</span>
                <div class="box">TutorEngine</div>
                <span class="arrow">‚Üí</span>
                <div class="box">AI API</div>
            </div>
            <br>
            <div class="flow">
                <div class="box">Response</div>
                <span class="arrow">‚Üí</span>
                <div class="box">MessageParser</div>
                <span class="arrow">‚Üí</span>
                <div class="box">PythonEngine</div>
                <span class="arrow">‚Üí</span>
                <div class="box">Display</div>
            </div>
        </div>

        <h3>Key Components</h3>
        <table>
            <tr>
                <th>Component</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>TutorEngine</code></td>
                <td>Main controller - handles messages, API calls, coordinates other components</td>
            </tr>
            <tr>
                <td><code>PythonEngine</code></td>
                <td>Pyodide wrapper - executes Python/matplotlib code in browser</td>
            </tr>
            <tr>
                <td><code>ContentFilter</code></td>
                <td>Filters inappropriate content based on JSON configuration</td>
            </tr>
            <tr>
                <td><code>DrawingTool</code></td>
                <td>Canvas-based drawing interface with multiple tools and backgrounds</td>
            </tr>
            <tr>
                <td><code>ConversationManager</code></td>
                <td>IndexedDB-based storage for saving/loading conversations</td>
            </tr>
            <tr>
                <td><code>LanguageManager</code></td>
                <td>Internationalization and dynamic translation</td>
            </tr>
            <tr>
                <td><code>MessageParser</code></td>
                <td>Markdown rendering and code block extraction</td>
            </tr>
        </table>
    </section>

    <section id="features">
        <h2>Features Summary</h2>
        
        <h3>Student-Facing Features</h3>
        <ul>
            <li><strong>Ask Questions:</strong> Natural language math questions with guided responses</li>
            <li><strong>View Visualizations:</strong> Auto-generated graphs, charts, and diagrams</li>
            <li><strong>Upload Images:</strong> Camera or file upload for checking handwritten work</li>
            <li><strong>Draw Solutions:</strong> Interactive canvas with coordinate grids</li>
            <li><strong>Listen to Responses:</strong> Text-to-speech in multiple voices</li>
            <li><strong>Save Conversations:</strong> Keep and resume learning sessions</li>
            <li><strong>Switch Themes:</strong> Light or dark mode for comfort</li>
        </ul>

        <h3>Safety Features</h3>
        <ul>
            <li>Content filtering with configurable blocklist</li>
            <li>PII detection (email, phone, SSN)</li>
            <li>Age-appropriate response tailoring</li>
            <li>No-cheating guidance approach</li>
        </ul>
    </section>

    <section id="theming">
        <h2>Light/Dark Theming</h2>
        
        <p>The app supports full light and dark themes, including themed Python visualizations.</p>

        <h3>Theme Toggle</h3>
        <pre><code>// In TutorEngine
applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('mathTutorTheme', theme);
}

toggleTheme() {
    const current = document.body.getAttribute('data-theme') || 'dark';
    this.applyTheme(current === 'dark' ? 'light' : 'dark');
}</code></pre>

        <h3>Theme-Aware Python Graphs</h3>
        <p>Graphs automatically adapt to the current theme:</p>
        <pre><code>// Colors are injected into Python code based on theme
injectThemeColors(code, isDark) {
    if (!isDark) {
        code = code.replace(/#1a1a2e/g, '#ffffff');
        code = code.replace(/#f0f0f0/g, '#1a1a2e');
        // ... more replacements
    }
    return code;
}</code></pre>

        <h3>CSS Theme Variables</h3>
        <table>
            <tr><th>Variable</th><th>Dark</th><th>Light</th></tr>
            <tr><td>--bg-color</td><td>#1a1a2e</td><td>#ffffff</td></tr>
            <tr><td>--text-color</td><td>#f0f0f0</td><td>#1a1a2e</td></tr>
            <tr><td>--chart-bg</td><td>#1a1a2e</td><td>#ffffff</td></tr>
            <tr><td>--chart-text</td><td>#f0f0f0</td><td>#1a1a2e</td></tr>
            <tr><td>--chart-grid</td><td>#444444</td><td>#cccccc</td></tr>
        </table>
    </section>

    <section id="content-filter">
        <h2>Content Filter System</h2>
        
        <p>The content filter uses an external JSON file that can be updated without code changes.</p>

        <h3>Configuration File: <code>data/content-filter.json</code></h3>
        <pre><code>{
  "blockedWords": ["word1", "word2"],
  "blockedPhrases": ["phrase to block"],
  "replacements": {
    "mild_word": "replacement"
  },
  "warningPatterns": ["personal information"]
}</code></pre>

        <h3>Adding New Blocked Content</h3>
        <p>Simply edit the JSON file and add words/phrases to the appropriate arrays. Changes take effect on next page load.</p>

        <h3>Usage in TutorEngine</h3>
        <pre><code>// Check content before sending
const filterResult = await this.contentFilter.checkContent(message);
if (filterResult.isBlocked) {
    this.addSystemMessage(`‚ö†Ô∏è ${filterResult.reason}`);
    return;
}</code></pre>
    </section>

    <section id="drawing-tool">
        <h2>Drawing Tool</h2>
        
        <p>The drawing tool provides an interactive canvas for students to show their work.</p>

        <h3>Features</h3>
        <ul>
            <li><strong>Tools:</strong> Pen, Line, Point, Eraser, Select/Move</li>
            <li><strong>Backgrounds:</strong> Blank, Coordinate Grid, Dot Grid, Lined Paper</li>
            <li><strong>Actions:</strong> Undo, Clear, Download, Submit to Tutor</li>
            <li><strong>Import:</strong> Can load tutor-generated images as backgrounds</li>
        </ul>

        <h3>Opening the Drawing Tool</h3>
        <pre><code>// Basic open
window.drawingTool.open();

// With options
window.drawingTool.open({
    background: 'grid',           // blank, grid, dots, lined
    backgroundImage: imageDataUrl, // Optional: set background image
    clear: true,                  // Clear previous drawing
    onSubmit: (imageData) => {    // Callback when submitted
        this.handleDrawingSubmission(imageData);
    }
});</code></pre>

        <h3>Tutor-Assigned Tasks</h3>
        <p>The tutor can generate a visualization and have students draw on it:</p>
        <pre><code>// After generating a Python graph, add a "Draw on this" button
<button onclick="window.mathTutor.openDrawingWithBackground('${imgSrc}')">
    ‚úèÔ∏è Draw on this
</button></code></pre>
    </section>

    <section id="image-upload">
        <h2>Image Upload & Vision</h2>
        
        <p>Students can upload images or take photos for the tutor to review.</p>

        <h3>Upload Methods</h3>
        <ul>
            <li><strong>File Upload:</strong> Click üì∑ button to select an image file</li>
            <li><strong>Camera:</strong> Click üì∏ button to take a photo (mobile)</li>
            <li><strong>Drawing Tool:</strong> Submit drawings directly to the tutor</li>
        </ul>

        <h3>Vision API Integration</h3>
        <pre><code>async callVisionAPI(message, imageData) {
    const response = await fetch(`${this.API_BASE}/v1/chat/completions`, {
        method: 'POST',
        headers: { ... },
        body: JSON.stringify({
            model: 'gpt-4.1-mini',  // Vision model
            messages: [{
                role: 'user',
                content: [
                    { type: 'text', text: message },
                    { type: 'image_url', image_url: { url: imageData } }
                ]
            }]
        })
    });
}</code></pre>

        <h3>Uploaded Images in Messages</h3>
        <p>Uploaded images are displayed inline in the chat and stored with the conversation.</p>
    </section>

    <section id="conversations">
        <h2>Conversation Management</h2>
        
        <p>Conversations are saved locally using IndexedDB (with localStorage fallback).</p>

        <h3>Storage Structure</h3>
        <pre><code>{
    id: "conv_1234567890_abc123",
    name: "Algebra Homework",
    date: "2025-01-15T10:30:00Z",
    messages: [
        { role: "user", content: "...", hasImage: false },
        { role: "assistant", content: "..." }
    ],
    images: {
        0: "data:image/png;base64,..."  // Message index ‚Üí image data
    },
    grade: "middle",
    lang: "en"
}</code></pre>

        <h3>API Methods</h3>
        <pre><code>// Save current conversation
await conversationManager.saveConversation({
    name: "My Chat",
    messages: chatHistory,
    images: messageImages,
    grade: "middle"
});

// Load conversations list
const list = await conversationManager.getConversations();

// Load specific conversation
const conv = await conversationManager.loadConversation(id);

// Delete conversation
await conversationManager.deleteConversation(id);

// Rename conversation
await conversationManager.renameConversation(id, "New Name");</code></pre>
    </section>

    <section id="visualizations">
        <h2>Adding New Visualizations</h2>
        
        <p>The AI generates Python code for visualizations. To add new types:</p>

        <h3>Step 1: Update System Prompt</h3>
        <p>In <code>tutor-engine.js</code>, add your visualization type to the system prompt's examples.</p>

        <h3>Step 2: Test with Natural Language</h3>
        <p>Ask the tutor: "Show me a [your visualization type]"</p>

        <h3>Theme-Aware Colors</h3>
        <p>Always use these colors in Python code for proper theming:</p>
        <pre><code># Dark theme (default)
bg_color = '#1a1a2e'
text_color = '#f0f0f0'
grid_color = '#444444'

# Light theme (will be auto-replaced)
# bg_color ‚Üí '#ffffff'
# text_color ‚Üí '#1a1a2e'
# grid_color ‚Üí '#cccccc'

# These colors work in both themes:
primary = '#00d4ff'
secondary = '#ff6b6b'
accent = '#d4af37'
success = '#27ae60'</code></pre>
    </section>

    <section id="colors">
        <h2>Color Reference</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Purpose</th>
                    <th>Color</th>
                    <th>Hex Code</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Primary (lines, fills)</td>
                    <td><span class="color-swatch" style="background: #00d4ff;"></span>Cyan</td>
                    <td><code>#00d4ff</code></td>
                </tr>
                <tr>
                    <td>Secondary (highlights, points)</td>
                    <td><span class="color-swatch" style="background: #ff6b6b;"></span>Coral</td>
                    <td><code>#ff6b6b</code></td>
                </tr>
                <tr>
                    <td>Accent (titles, labels)</td>
                    <td><span class="color-swatch" style="background: #d4af37;"></span>Gold</td>
                    <td><code>#d4af37</code></td>
                </tr>
                <tr>
                    <td>Success</td>
                    <td><span class="color-swatch" style="background: #27ae60;"></span>Green</td>
                    <td><code>#27ae60</code></td>
                </tr>
                <tr>
                    <td>Error</td>
                    <td><span class="color-swatch" style="background: #e74c3c;"></span>Red</td>
                    <td><code>#e74c3c</code></td>
                </tr>
                <tr>
                    <td>Dark Background</td>
                    <td><span class="color-swatch" style="background: #1a1a2e;"></span>Navy</td>
                    <td><code>#1a1a2e</code></td>
                </tr>
                <tr>
                    <td>Light Background</td>
                    <td><span class="color-swatch" style="background: #ffffff; border: 1px solid #ccc;"></span>White</td>
                    <td><code>#ffffff</code></td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="api">
        <h2>API Integration</h2>
        
        <h3>Models Used</h3>
        <table>
            <tr><th>Purpose</th><th>Model</th></tr>
            <tr><td>Main Tutor</td><td>grok</td></tr>
            <tr><td>Vision/Image Analysis</td><td>gpt-4.1-mini</td></tr>
            <tr><td>Code Generation</td><td>qwen-coder</td></tr>
            <tr><td>Search/Current Info</td><td>gemini-search</td></tr>
            <tr><td>Text-to-Speech</td><td>openai-audio</td></tr>
        </table>

        <h3>API Endpoints</h3>
        <pre><code>Base URL: https://gen.pollinations.ai

// Chat completions
POST /v1/chat/completions
{
    model: "grok",
    messages: [...],
    temperature: 0.7
}

// Vision (with images)
POST /v1/chat/completions
{
    model: "gpt-4.1-mini",
    messages: [{
        role: "user",
        content: [
            { type: "text", text: "..." },
            { type: "image_url", image_url: { url: "data:..." } }
        ]
    }]
}

// Audio/TTS
POST /v1/chat/completions
{
    model: "openai-audio",
    modalities: ["text", "audio"],
    audio: { voice: "alloy", format: "mp3" },
    messages: [...]
}</code></pre>
    </section>

</div>

<footer>
    <p>Math Tutor Developer Guide ‚Ä¢ Version 3.0</p>
    <p>Last Updated: January 2025</p>
</footer>

</body>
</html>
